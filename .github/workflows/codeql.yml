name: "CodeQL Analysis"

on:
  push:
    branches: ["main"]
    paths:
      - "**/*.swift"
      - "**/Package.swift"
      - "**/Package.resolved"
      - "**/*.xcodeproj/**"
      - ".github/workflows/codeql.yml"
  pull_request:
    branches: ["main"]
    paths:
      - "**/*.swift"
      - "**/Package.swift"
      - "**/Package.resolved"
      - "**/*.xcodeproj/**"
      - ".github/workflows/codeql.yml"
  schedule:
    - cron: "30 1 * * 1" # Run weekly on Mondays at 1:30 AM UTC

permissions:
  contents: read

# Ensure that we cancel older instances of running workflows for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze:
    name: Analyze Swift
    runs-on: macos-15
    timeout-minutes: 10

    permissions:
      security-events: write # Required for all workflows
      packages: read # Required to fetch internal or private CodeQL packs
      actions: read # Required to upload the results to code-scanning dashboard
      contents: read

    steps:
      - name: Checkout repository
        id: checkout
        uses: actions/checkout@8edcb1bdb4e267140fa742c62e395cd74f332709 # 11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          # Need more history to properly detect changes in PRs
          fetch-depth: 0

      - name: Record start time
        id: start-time
        run: echo "timestamp=$(date +%s)" >> $GITHUB_OUTPUT

      # Check if only docs/non-code files changed
      - name: Check for code changes
        id: code-changes
        env:
          EVENT_NAME: ${{ github.event_name }}
          BASE_REF: ${{ github.base_ref }}
          HEAD_REF: ${{ github.head_ref }}
        run: |
          # Get list of changed files
          if [ "$EVENT_NAME" = "pull_request" ]; then
            # Fetch the base branch with enough history to find the merge base
            git fetch --no-tags --depth=50 origin "$BASE_REF"
            # Try to find the merge base, if that fails use two-dot diff
            MERGE_BASE=$(git merge-base "origin/$BASE_REF" HEAD 2>/dev/null || echo "")
            if [ -n "$MERGE_BASE" ]; then
              CHANGED_FILES=$(git diff --name-only "$MERGE_BASE" HEAD || echo "")
            else
              # Fallback to comparing the branches directly
              CHANGED_FILES=$(git diff --name-only "origin/$BASE_REF..HEAD" || echo "")
            fi
            
            # Debug output
            echo "🔍 Detected PR from $HEAD_REF to $BASE_REF"
            echo "📊 Changed files count: $(echo "$CHANGED_FILES" | wc -l)"
          else
            # For push events, compare with the parent commit if available
            if git rev-parse HEAD^ >/dev/null 2>&1; then
              CHANGED_FILES=$(git diff --name-only HEAD^ HEAD || echo "")
            else
              # First commit in the repository, treat all files as changed
              CHANGED_FILES=$(git ls-tree -r --name-only HEAD || echo "")
            fi
          fi

          # Debug: Show some changed files
          if [ -n "$CHANGED_FILES" ]; then
            echo "📝 Sample of changed files:"
            echo "$CHANGED_FILES" | head -5
          fi

          # Check if any Swift files or build files changed
          if echo "$CHANGED_FILES" | grep -qE '\.(swift|xcodeproj|pbxproj|yml|yaml)$|Package\.swift|Package\.resolved'; then
            echo "has-code-changes=true" >> $GITHUB_OUTPUT
            echo "🔍 Code changes detected - CodeQL analysis needed"
            echo "🚀 Swift files found in changes"
          else
            echo "has-code-changes=false" >> $GITHUB_OUTPUT
            echo "📄 Only documentation/non-code changes - CodeQL can be skipped"
          fi

      # Cache CodeQL database to speed up subsequent runs
      - name: Cache CodeQL database
        id: cache-codeql
        if: steps.code-changes.outputs.has-code-changes == 'true'
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4
        with:
          path: |
            .codeql
            ~/codeql-home/codeql-dbs
            MagSafeGuardLib/.build
            ~/hostedtoolcache/CodeQL
          key: ${{ runner.os }}-${{ runner.arch }}-codeql-db-${{ hashFiles('**/*.swift', 'MagSafeGuardLib/Package.swift') }}-v6-macos15
          restore-keys: |
            ${{ runner.os }}-${{ runner.arch }}-codeql-db-${{ hashFiles('**/*.swift', 'MagSafeGuardLib/Package.swift') }}-
            ${{ runner.os }}-${{ runner.arch }}-codeql-db-
            ${{ runner.os }}-${{ runner.arch }}-codeql-

      - name: Initialize CodeQL
        if: steps.code-changes.outputs.has-code-changes == 'true'
        uses: github/codeql-action/init@51f77329afa6477de8c49fc9c7046c15b9a4e79d # v3.29.5
        with:
          languages: swift
          build-mode: manual
          queries: security-extended,security-and-quality

      - name: Setup Swift Build Environment
        id: setup-swift
        if: steps.code-changes.outputs.has-code-changes == 'true'
        uses: ./.github/actions/swift
        with:
          cache-key-suffix: codeql
          swift-version: "6.0"

      - name: Build Swift Project for CodeQL
        if: steps.code-changes.outputs.has-code-changes == 'true'
        timeout-minutes: 5
        run: |
          echo "🔨 Building project for CodeQL analysis..."

          # Skip build if CodeQL database was cached and is recent
          if [ "${{ steps.cache-codeql.outputs.cache-hit }}" = "true" ]; then
            # Check if cached database is less than 7 days old
            if find .codeql -name "*.trap" -mtime -7 2>/dev/null | grep -q .; then
              echo "✅ Using cached CodeQL database (less than 7 days old)"
              exit 0
            fi
          fi

          # Navigate to SPM package directory
          cd MagSafeGuardLib

          # Use minimal build for CodeQL
          swift build --target MagSafeGuardDomain -c debug || true
          echo "✅ Build completed for CodeQL"

      - name: Perform CodeQL Analysis
        if: steps.code-changes.outputs.has-code-changes == 'true'
        uses: github/codeql-action/analyze@51f77329afa6477de8c49fc9c7046c15b9a4e79d # v3.29.5
        with:
          category: "/language:swift"
          upload: true
          upload-database: true

      # Save CodeQL database location for debugging
      - name: Save CodeQL database info
        if: always()
        run: |
          echo "CodeQL database locations:"
          find . -name "*.sarif" -type f 2>/dev/null | head -10 || echo "No SARIF files found"
          find . -name "codeql-database.yml" -type f 2>/dev/null | head -10 || echo "No database config found"
          find ~/codeql-home -name "*.trap" -type f 2>/dev/null | wc -l || echo "0"
          echo "CodeQL trap files in home"

      # Generate workflow summary
      - name: Generate CodeQL Summary
        if: always()
        run: |
          if [ "${{ steps.code-changes.outputs.has-code-changes }}" != "true" ]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ## 🔍 CodeQL Analysis Summary

          | Property | Value |
          |----------|-------|
          | **Status** | ⏭️ Skipped (no code changes) |
          | **Analysis Time** | ~$(( ($(date +%s) - ${{ steps.start-time.outputs.timestamp }}) / 60 ))m $(( ($(date +%s) - ${{ steps.start-time.outputs.timestamp }}) % 60 ))s |

          > CodeQL analysis was skipped because only documentation or non-code files were changed.
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ## 🔍 CodeQL Analysis Summary

          | Property | Value |
          |----------|-------|
          | **Language** | Swift |
          | **Build Mode** | manual |
          | **Build Executed** | ${{ steps.cache-codeql.outputs.cache-hit == 'true' && 'Skipped (cached)' || 'Yes' }} |
          | **Analysis Time** | ~$(( ($(date +%s) - ${{ steps.start-time.outputs.timestamp }}) / 60 ))m $(( ($(date +%s) - ${{ steps.start-time.outputs.timestamp }}) % 60 ))s |

          ### 📊 Cache Performance

          | Cache Type | Status |
          |------------|--------|
          | **SPM Build Cache** | \${{ steps.setup-swift.outputs.spm-cache-hit || 'miss' }} |
          | **CodeQL Database** | \${{ steps.cache-codeql.outputs.cache-hit || 'miss' }} |

          ### 📁 Build Artifacts

          \`\`\`
          $(du -sh MagSafeGuardLib/.build/debug/ 2>/dev/null || echo "No SPM build products")
          $(du -sh MagSafeGuardLib/.build/ 2>/dev/null || echo "No SPM build directory")
          $(du -sh .codeql/ 2>/dev/null || echo "No CodeQL database")
          \`\`\`

          ### ⚡ Optimizations Applied:
          EOF
            
            if [ "${{ steps.cache-codeql.outputs.cache-hit }}" = "true" ]; then
              echo "- ✅ Used cached CodeQL database" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "${{ steps.setup-swift.outputs.swift-available }}" = "true" ]; then
              echo "- ✅ Swift pre-installed (no download needed)" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
