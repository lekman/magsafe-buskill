name: Basic Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  # Basic security checks without external services
  security-checks:
    name: Security Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Check for secrets in code
      run: |
        echo "ðŸ” Checking for potential secrets..."
        
        # Basic patterns to check
        patterns=(
          "password.*=.*['\"].*['\"]"
          "api[_-]?key.*=.*['\"].*['\"]"
          "secret.*=.*['\"].*['\"]"
          "token.*=.*['\"].*['\"]"
          "private[_-]?key"
          "BEGIN RSA PRIVATE KEY"
          "BEGIN DSA PRIVATE KEY"
          "BEGIN EC PRIVATE KEY"
          "BEGIN PGP PRIVATE KEY"
          "aws_access_key_id"
          "aws_secret_access_key"
        )
        
        found_secrets=0
        for pattern in "${patterns[@]}"; do
          if grep -r -i -E "$pattern" . --exclude-dir={.git,node_modules,vendor} --exclude="*.md" --exclude="security-basic.yml" 2>/dev/null; then
            echo "âš ï¸  Warning: Potential secret found matching pattern: $pattern"
            found_secrets=$((found_secrets + 1))
          fi
        done
        
        if [ $found_secrets -gt 0 ]; then
          echo "âŒ Found $found_secrets potential secrets. Please review and remove any actual secrets."
          exit 1
        else
          echo "âœ… No obvious secrets found in code."
        fi
        
    - name: Check file permissions
      run: |
        echo "ðŸ” Checking for overly permissive files..."
        
        # Find files with overly permissive permissions
        permissive_files=$(find . -type f -perm /go+w -not -path "./.git/*" 2>/dev/null | head -20)
        
        if [ -n "$permissive_files" ]; then
          echo "âš ï¸  Warning: Found files with overly permissive permissions:"
          echo "$permissive_files"
        else
          echo "âœ… No overly permissive files found."
        fi
        
    - name: Security headers check
      run: |
        echo "ðŸ” Checking for security-related TODOs..."
        
        security_todos=$(grep -r "TODO.*security\|FIXME.*security\|XXX.*security\|HACK.*security" . --exclude-dir=.git 2>/dev/null || true)
        
        if [ -n "$security_todos" ]; then
          echo "ðŸ“ Found security-related TODOs:"
          echo "$security_todos"
        else
          echo "âœ… No security TODOs found."
        fi
        
    - name: Check for hardcoded IPs and URLs
      run: |
        echo "ðŸ” Checking for hardcoded IPs and suspicious URLs..."
        
        # Check for hardcoded IPs (excluding common safe ones)
        ips=$(grep -r -E "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b" . --exclude-dir={.git,docs} --exclude="*.md" 2>/dev/null | grep -v -E "(127\.0\.0\.1|0\.0\.0\.0|255\.255\.255\.255|localhost)" | head -10 || true)
        
        if [ -n "$ips" ]; then
          echo "âš ï¸  Found hardcoded IP addresses:"
          echo "$ips"
        fi
        
        # Check for suspicious URLs
        urls=$(grep -r -E "https?://[^/]+" . --exclude-dir={.git,docs} --exclude="*.md" 2>/dev/null | grep -v -E "(github\.com|apple\.com|localhost|example\.com)" | head -10 || true)
        
        if [ -n "$urls" ]; then
          echo "ðŸ”— Found external URLs (review for security):"
          echo "$urls"
        fi
        
    - name: Summary
      run: |
        echo "## ðŸ”’ Basic Security Scan Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "This basic scan checks for:" >> $GITHUB_STEP_SUMMARY
        echo "- Potential secrets in code" >> $GITHUB_STEP_SUMMARY
        echo "- Overly permissive file permissions" >> $GITHUB_STEP_SUMMARY
        echo "- Security-related TODOs" >> $GITHUB_STEP_SUMMARY
        echo "- Hardcoded IPs and URLs" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "For more comprehensive scanning, consider setting up Semgrep with an app token." >> $GITHUB_STEP_SUMMARY