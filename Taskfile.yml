version: "3"

vars:
  HOOKS_PATH: .githooks
  SEMGREP_CONFIG: auto

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  init:
    desc: Initialize development environment
    cmds:
      - task: check-tools
      - task: setup-hooks
      - task: setup-sbom
      - task: verify-setup
    silent: true

  check-tools:
    desc: Check required development tools
    cmds:
      - |
        echo "ðŸ” Checking development tools..."
        missing_tools=0

        # Check for git
        if ! command -v git &> /dev/null; then
          echo "âŒ git is not installed"
          missing_tools=$((missing_tools + 1))
        else
          echo "âœ… git $(git --version | awk '{print $3}')"
        fi

        # Check for Swift
        if ! command -v swift &> /dev/null; then
          echo "âŒ Swift is not installed"
          missing_tools=$((missing_tools + 1))
        else
          echo "âœ… Swift $(swift --version | head -1 | awk '{print $4}')"
        fi

        # Check for Semgrep (optional)
        if ! command -v semgrep &> /dev/null; then
          echo "âš ï¸  Semgrep not installed (optional but recommended)"
          echo "   Install with: brew install semgrep"
        else
          echo "âœ… Semgrep $(semgrep --version | head -1)"
        fi

        if [ $missing_tools -gt 0 ]; then
          exit 1
        fi
    silent: true

  setup-sbom:
    desc: Setup SBOM generation dependencies
    cmds:
      - |
        echo "ðŸ” Checking SBOM dependencies..."
        if ! command -v jq &> /dev/null; then
          echo "âš ï¸  jq not installed (required for SBOM generation)"
          echo "   Install with: brew install jq"
        else
          echo "âœ… jq $(jq --version)"
        fi
        
        if ! command -v uuidgen &> /dev/null; then
          echo "âš ï¸  uuidgen not found (should be built-in on macOS)"
        else
          echo "âœ… uuidgen available"
        fi
        
        echo "âœ… SBOM generation ready (using Swift Package Manager)"
    silent: true

  setup-hooks:
    desc: Configure git hooks for MagSafe Guard development
    vars:
      CURRENT_HOOKS_PATH:
        sh: git config core.hooksPath || echo ""
    status:
      - test "{{.CURRENT_HOOKS_PATH}}" = "{{.HOOKS_PATH}}"
    cmds:
      - |
        echo "ðŸ”§ Setting up MagSafe Guard development environment..."

        # Configure git to use our hooks directory
        git config core.hooksPath {{.HOOKS_PATH}}
        chmod +x {{.HOOKS_PATH}}/* 2>/dev/null || true

        echo "âœ… Git hooks configured"

        # Check if Semgrep is installed
        if command -v semgrep &> /dev/null; then
          echo "âœ… Semgrep is installed (version: $(semgrep --version | head -1))"
        else
          echo "â„¹ï¸  Semgrep not installed (optional but recommended)"
          echo "   To install: brew install semgrep"
          echo "   Pre-commit will still run basic security checks"
        fi

        echo ""
        echo "Git hooks will now:"
        echo "  â€¢ Check for hardcoded secrets in Swift files"
        echo "  â€¢ Detect private key files"
        echo "  â€¢ Prevent committing .env files"
        echo "  â€¢ Run Semgrep scan (if installed)"
        echo "  â€¢ Validate commit message format (Conventional Commits)"
        echo "  â€¢ Block certain words in commit messages"
        echo ""
        echo "To bypass hooks in emergencies: git commit --no-verify"
        echo "To skip Semgrep only: SKIP_SEMGREP=1 git commit"
    silent: true

  verify-setup:
    desc: Verify development setup
    cmds:
      - |
        echo ""
        echo "ðŸŽ‰ Development environment ready!"
        echo ""
        echo "Git hooks installed:"
        hooks_path=$(git config core.hooksPath)
        if [ -n "$hooks_path" ]; then
          echo "  â€¢ Pre-commit: Security scanning"
          echo "  â€¢ Commit-msg: Conventional commits validation"
        fi
        echo ""
        echo "Next steps:"
        echo "  1. Make changes to the code"
        echo "  2. Commit with conventional format: git commit -m 'feat: description'"
        echo "  3. Run 'task test' before pushing"
    silent: true

  test:
    desc: Run all tests
    cmds:
      - task: test:security
      - task: test:swift
      - echo "âœ… All tests passed!"

  test:security:
    desc: Run security checks locally
    silent: true
    cmds:
      - |
        echo "ðŸ”’ Running security checks..."

        # Basic secret scanning
        if find . -name "*.swift" -type f -exec grep -l -E "password\s*=\s*\"[^\"]+\"" {} \; 2>/dev/null | head -1 | grep -q .; then
          echo "âŒ Found hardcoded passwords"
          exit 1
        fi

        # Check for private keys
        if find . -type f \( -name "*.pem" -o -name "*.key" \) -not -path "./.git/*" | head -1 | grep -q .; then
          echo "âŒ Found private key files"
          exit 1
        fi

        echo "âœ… Basic security checks passed"

        # Run Semgrep if available
        if command -v semgrep &> /dev/null; then
          echo "Running Semgrep scan..."
          semgrep --config={{.SEMGREP_CONFIG}} --error --quiet . || exit 1
          echo "âœ… Semgrep scan passed"
        fi

  test:swift:
    desc: Run Swift tests
    silent: true
    cmds:
      - |
        echo "ðŸ§ª Running Swift tests..."
        swift test

  test:ci:
    desc: Run tests (same as test, kept for compatibility)
    cmds:
      - task: test

  test:coverage:
    desc: Run tests with coverage and ensure >80%
    cmds:
      - echo "Running tests with coverage..."
      - swift test --enable-code-coverage
      - |
        echo "Generating coverage report..."
        PROF_DATA=$(find .build -name 'default.profdata' -type f | head -1)
        EXECUTABLE=$(find .build -name 'MagSafeGuardPackageTests.xctest' -type d | head -1)/Contents/MacOS/MagSafeGuardPackageTests

        if [[ -f "$PROF_DATA" && -f "$EXECUTABLE" ]]; then
          # Generate detailed coverage report
          xcrun llvm-cov report "$EXECUTABLE" \
            -instr-profile="$PROF_DATA" \
            -ignore-filename-regex=".*Tests\.swift|.*Mock.*\.swift|.*/runner.swift|.*/MagSafeGuardApp\.swift|.*/PowerMonitorService\.swift|.*/PowerMonitorCore\.swift|.*LAContext\.swift|.*/MacSystemActions\.swift|.*Protocol\.swift" | tee coverage-report.txt
          
          # Extract total coverage percentage (line coverage is in column 10)
          COVERAGE=$(tail -1 coverage-report.txt | awk '{print $10}' | sed 's/%//')
          
          echo ""
          echo "Total coverage: ${COVERAGE}%"
          
          # Check if coverage meets threshold
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "âŒ Coverage is below 80% threshold!"
            echo ""
            echo "To improve coverage, add tests for:"
            grep -E "^\S+\.swift" coverage-report.txt | grep -v "100.00%" | head -10
            rm coverage-report.txt
            exit 1
          else
            echo "âœ… Coverage meets 80% threshold!"
            rm coverage-report.txt
          fi
        else
          echo "âŒ Error: Could not find coverage data files"
          exit 1
        fi

  test:coverage:html:
    desc: Generate HTML coverage report
    cmds:
      - swift test --enable-code-coverage
      - |
        PROF_DATA=$(find .build -name 'default.profdata' -type f | head -1)
        EXECUTABLE=$(find .build -name 'MagSafeGuardPackageTests.xctest' -type d | head -1)/Contents/MacOS/MagSafeGuardPackageTests

        if [[ -f "$PROF_DATA" && -f "$EXECUTABLE" ]]; then
          xcrun llvm-cov show "$EXECUTABLE" \
            -instr-profile="$PROF_DATA" \
            -format=html \
            -output-dir=coverage-html \
            -ignore-filename-regex=".*Tests\.swift|.*Mock.*\.swift|.*/MagSafeGuardApp\.swift|.*/PowerMonitorService\.swift|.*/PowerMonitorCore\.swift|.*LAContext\.swift|.*/MacSystemActions\.swift|.*Protocol\.swift"
          echo "Coverage report generated at: coverage-html/index.html"
          open coverage-html/index.html
        fi

  lint:
    desc: Run linters
    cmds:
      - task: lint:swift
      - task: lint:markdown

  lint:swift:
    desc: Lint Swift files
    silent: true
    cmds:
      - |
        echo "ðŸ” Linting Swift files..."
        if command -v swiftlint &> /dev/null; then
          swiftlint lint --quiet
        else
          echo "âš ï¸  SwiftLint not installed"
          echo "   Install with: brew install swiftlint"
        fi

  lint:markdown:
    desc: Lint Markdown files
    silent: true
    cmds:
      - |
        echo "ðŸ” Linting Markdown files..."

        # Check if markdownlint is installed
        if ! command -v markdownlint &> /dev/null; then
          echo "ðŸ“¦ markdownlint not found. Installing..."
          
          # Try to install with npm first (most universal)
          if command -v npm &> /dev/null; then
            echo "Installing with npm..."
            npm install -g markdownlint-cli
          # Try Homebrew as fallback
          elif command -v brew &> /dev/null; then
            echo "Installing with Homebrew..."
            brew install markdownlint-cli
          else
            echo "âš ï¸  Cannot auto-install markdownlint"
            echo "   Please install Node.js or Homebrew first"
            exit 1
          fi
        fi

        # Run the linter
        markdownlint '**/*.md' --ignore node_modules

  lint:fix:
    desc: Fix linting issues automatically
    cmds:
      - task: lint:fix:markdown
      - echo "âœ… Linting fixes complete!"

  lint:fix:markdown:
    desc: Fix Markdown formatting issues
    silent: true
    cmds:
      - |
        echo "ðŸ”§ Fixing Markdown formatting issues..."

        # Check if markdownlint is installed
        if ! command -v markdownlint &> /dev/null; then
          echo "ðŸ“¦ markdownlint not found. Installing..."
          
          # Try to install with npm first (most universal)
          if command -v npm &> /dev/null; then
            echo "Installing with npm..."
            npm install -g markdownlint-cli
          # Try Homebrew as fallback
          elif command -v brew &> /dev/null; then
            echo "Installing with Homebrew..."
            brew install markdownlint-cli
          else
            echo "âŒ Neither npm nor Homebrew found"
            echo ""
            echo "Please install Node.js or Homebrew first:"
            echo "  - Node.js: https://nodejs.org/"
            echo "  - Homebrew: https://brew.sh/"
            exit 1
          fi
          
          # Verify installation
          if ! command -v markdownlint &> /dev/null; then
            echo "âŒ Installation failed"
            exit 1
          fi
          echo "âœ… markdownlint installed successfully"
        fi

        # Fix all markdown files
        echo "Running markdown formatter..."
        markdownlint '**/*.md' --ignore node_modules --fix
        echo "âœ… Markdown files formatted"

        # Show which files were modified
        echo ""
        echo "Modified files:"
        git diff --name-only | grep '\.md$' || echo "  No changes needed"

  clean:
    desc: Clean build artifacts
    silent: true
    cmds:
      - |
        echo "ðŸ§¹ Cleaning build artifacts..."
        rm -rf .build/
        rm -rf *.xcodeproj
        rm -rf coverage-html/
        rm -f coverage-report.txt
        rm -f coverage.lcov
        echo "âœ… Clean complete"

  run:
    desc: Build and run MagSafe Guard
    cmds:
      - |
        echo "ðŸš€ Building MagSafe Guard..."

        # Try xcodebuild first for proper bundling
        if command -v xcodebuild &> /dev/null; then
          xcodebuild -project MagSafeGuard.xcodeproj \
                     -scheme MagSafeGuard \
                     -configuration Debug \
                     -derivedDataPath build \
                     build
          
          if [ $? -eq 0 ]; then
            echo "âœ… Build successful!"
            APP_PATH="build/Build/Products/Debug/MagSafeGuard.app"
            if [ -d "$APP_PATH" ]; then
              echo "Launching MagSafe Guard..."
              open "$APP_PATH"
              echo "Look for the lock shield icon in your menu bar."
            fi
          else
            echo "âŒ Build failed"
            exit 1
          fi
        else
          # Fallback to swift build
          swift build
          echo "âœ… Build complete. Run: .build/debug/MagSafeGuard"
          echo "Note: For proper app bundle, use Xcode."
        fi

  dev:setup:
    desc: Complete development setup (hooks + tools)
    silent: true
    cmds:
      - task: init
      - |
        echo ""
        echo "ðŸ“¦ Installing recommended tools..."

        # Check if Homebrew is installed
        if command -v brew &> /dev/null; then
          echo "Installing/updating tools via Homebrew..."
          
          # Install Semgrep
          if ! command -v semgrep &> /dev/null; then
            brew install semgrep
          fi
          
          # Install SwiftLint
          if ! command -v swiftlint &> /dev/null; then
            brew install swiftlint
          fi
          
          # Install markdownlint
          if ! command -v markdownlint &> /dev/null; then
            brew install markdownlint-cli
          fi
          
          echo "âœ… Development tools installed"
        else
          echo "âš ï¸  Homebrew not found. Install tools manually:"
          echo "   - Semgrep: https://semgrep.dev/docs/getting-started/"
          echo "   - SwiftLint: https://github.com/realm/SwiftLint"
          echo "   - markdownlint: npm install -g markdownlint-cli"
        fi

  pr:fix:
    desc: Fix PR documentation formatting
    silent: true
    cmds:
      - |
        echo "ðŸ“ Fixing PR documentation..."
        pr_file=$(find . -name "pr.*.md" | head -1)
        if [ -n "$pr_file" ]; then
          echo "Found PR file: $pr_file"
          markdownlint "$pr_file" --fix
          echo "âœ… PR documentation fixed"
        else
          echo "No PR documentation found (pr.*.md)"
        fi

  pre-push:
    desc: Run all checks before pushing
    cmds:
      - echo "ðŸš€ Running pre-push checks..."
      - task: lint:fix:markdown
      - task: test:coverage
      - task: test:security
      - task: lint
      - echo "âœ… All pre-push checks passed!"
      - echo "Ready to push your changes."

  pre-pr:
    desc: Run all checks before creating a PR
    cmds:
      - echo "ðŸš€ Running pre-PR checks..."
      - task: lint:fix:markdown
      - task: test:coverage
      - task: test:security
      - task: lint
      - echo "âœ… All pre-PR checks passed!"
      - echo "Ready to create your PR."

  commit:
    desc: Interactive commit with conventional format
    cmds:
      - |
        echo "ðŸ“ Creating conventional commit..."
        echo ""
        echo "Select commit type:"
        echo "  1) feat     - New feature"
        echo "  2) fix      - Bug fix"
        echo "  3) docs     - Documentation"
        echo "  4) style    - Code style"
        echo "  5) refactor - Code refactoring"
        echo "  6) test     - Tests"
        echo "  7) chore    - Maintenance"
        echo ""
        read -p "Enter number (1-7): " type_num

        case $type_num in
          1) type="feat";;
          2) type="fix";;
          3) type="docs";;
          4) type="style";;
          5) type="refactor";;
          6) type="test";;
          7) type="chore";;
          *) echo "Invalid selection"; exit 1;;
        esac

        read -p "Enter scope (optional, press enter to skip): " scope
        read -p "Enter commit message: " message

        if [ -n "$scope" ]; then
          commit_msg="${type}(${scope}): ${message}"
        else
          commit_msg="${type}: ${message}"
        fi

        echo ""
        echo "Commit message: $commit_msg"
        read -p "Proceed? (y/n): " confirm

        if [ "$confirm" = "y" ]; then
          git commit -m "$commit_msg"
        else
          echo "Commit cancelled"
        fi
    interactive: true

  test:convert:
    desc: Convert Swift coverage to SonarQube generic XML format
    silent: true
    cmds:
      - |
        echo "ðŸ”„ Converting Swift coverage to SonarQube format..."

        # First, run tests with coverage if needed
        if [ ! -d ".build" ] || [ -z "$(find .build -name 'default.profdata' -type f 2>/dev/null)" ]; then
          echo "ðŸ§ª Running tests with coverage..."
          swift test --enable-code-coverage
        fi

        # Find the coverage data
        PROF_DATA=$(find .build -name 'default.profdata' -type f | head -1)
        EXECUTABLE=$(find .build -name 'MagSafeGuardPackageTests.xctest' -type d | head -1)/Contents/MacOS/MagSafeGuardPackageTests

        if [[ -f "$PROF_DATA" && -f "$EXECUTABLE" ]]; then
          echo "ðŸ“Š Generating SonarQube generic coverage XML..."
          
          # Function to convert xcov output to generic XML format
          convert_to_xml() {
            echo '<coverage version="1">'
            xcrun llvm-cov show "$EXECUTABLE" \
              -instr-profile="$PROF_DATA" \
              -use-color=false \
              -ignore-filename-regex=".*Tests\.swift|.*Mocks?\.swift|.*/MagSafeGuardApp\.swift|.*/PowerMonitorService\.swift|.*/PowerMonitorCore\.swift|.*LAContext\.swift|.*/MacSystemActions\.swift|.*Protocol\.swift" | \
            awk '
              /^[[:space:]]*[^[:space:]]+:$/ {
                if (in_file) print "  </file>"
                gsub(/:$/, "", $1)
                gsub(/&/, "\\&amp;", $1)
                print "  <file path=\"" $1 "\">"
                in_file = 1
                next
              }
              /^[[:space:]]*[0-9]+\|/ {
                split($0, parts, "|")
                linenum = parts[1]
                gsub(/^[[:space:]]+/, "", linenum)
                gsub(/[[:space:]]+$/, "", linenum)
                
                # Check if line is covered (has execution count)
                if (match(parts[2], /^[[:space:]]*[0-9]+/)) {
                  print "    <lineToCover lineNumber=\"" linenum "\" covered=\"true\"/>"
                } else if (match(parts[2], /^[[:space:]]*0/)) {
                  print "    <lineToCover lineNumber=\"" linenum "\" covered=\"false\"/>"
                }
              }
              END {
                if (in_file) print "  </file>"
              }
            '
            echo '</coverage>'
          }
          
          # Generate the coverage XML
          convert_to_xml > coverage.xml
          
          if [ -f "coverage.xml" ] && [ -s "coverage.xml" ]; then
            echo "âœ… Successfully generated coverage.xml"
            echo "   File size: $(wc -c < coverage.xml) bytes"
            echo "   Files covered: $(grep -c '<file path=' coverage.xml || echo 0)"
          else
            echo "âŒ Failed to create coverage.xml or file is empty"
            exit 1
          fi
        else
          echo "âŒ Coverage data not found"
          echo "PROF_DATA: $PROF_DATA"
          echo "EXECUTABLE: $EXECUTABLE"
          exit 1
        fi

  sbom:
    desc: Generate Software Bill of Materials (SBOM) in SPDX format
    cmds:
      - |
        echo "ðŸ“¦ Generating SBOM for Swift project..."
        
        # Get package info
        PACKAGE_NAME=$(swift package dump-package | jq -r '.name')
        VERSION=$(git describe --tags --always 2>/dev/null || echo "1.0.0")
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        # Create SPDX SBOM
        echo "SPDXVersion: SPDX-2.3" > sbom.spdx
        echo "DataLicense: CC0-1.0" >> sbom.spdx
        echo "SPDXID: SPDXRef-DOCUMENT" >> sbom.spdx
        echo "DocumentName: ${PACKAGE_NAME}" >> sbom.spdx
        echo "DocumentNamespace: https://github.com/lekman/magsafe-buskill/spdx-${VERSION}-$(date +%s)" >> sbom.spdx
        echo "Creator: Tool: swift-package-sbom-1.0.0" >> sbom.spdx
        echo "Created: ${TIMESTAMP}" >> sbom.spdx
        echo "" >> sbom.spdx
        
        # Package information
        echo "PackageName: ${PACKAGE_NAME}" >> sbom.spdx
        echo "SPDXID: SPDXRef-Package-${PACKAGE_NAME}" >> sbom.spdx
        echo "PackageVersion: ${VERSION}" >> sbom.spdx
        echo "PackageDownloadLocation: https://github.com/lekman/magsafe-buskill" >> sbom.spdx
        echo "FilesAnalyzed: false" >> sbom.spdx
        echo "PackageLicenseConcluded: MIT" >> sbom.spdx
        echo "PackageLicenseDeclared: MIT" >> sbom.spdx
        echo "PackageCopyrightText: Copyright (c) 2025 Tobias Lekman" >> sbom.spdx
        echo "" >> sbom.spdx
        
        # Relationship
        echo "Relationship: SPDXRef-DOCUMENT DESCRIBES SPDXRef-Package-${PACKAGE_NAME}" >> sbom.spdx
        
        # Process dependencies
        echo "" >> sbom.spdx
        echo "# Dependencies" >> sbom.spdx
        DEPS=$(swift package show-dependencies --format json | jq -r '.dependencies[]? | "PackageName: " + .name + "\nSPDXID: SPDXRef-Package-" + .identity + "\nPackageVersion: " + (.version // "unknown") + "\nPackageDownloadLocation: " + (.url // "NOASSERTION") + "\nFilesAnalyzed: false\nPackageLicenseConcluded: NOASSERTION\nPackageLicenseDeclared: NOASSERTION\nPackageCopyrightText: NOASSERTION\n\nRelationship: SPDXRef-Package-" + .identity + " DEPENDENCY_OF SPDXRef-Package-${PACKAGE_NAME}\n"' 2>/dev/null || echo "")
        
        if [ -n "$DEPS" ]; then
          echo "$DEPS" >> sbom.spdx
        fi
        
        echo "âœ… SBOM generated: sbom.spdx"
        echo "   Format: SPDX 2.3"
        echo "   Project: ${PACKAGE_NAME} v${VERSION}"
        
        # Also generate in JSON format
        swift package show-dependencies --format json > sbom-deps.json
        
        echo "âœ… Also generated: sbom-deps.json (Swift dependencies)"
    sources:
      - Package.swift
      - Sources/**/*.swift
    generates:
      - sbom.spdx
      - sbom-deps.json

  sbom:install:
    desc: Install SBOM generation dependencies
    cmds:
      - |
        echo "ðŸ“¦ Installing SBOM dependencies..."
        
        # Check if Homebrew is installed
        if ! command -v brew &> /dev/null; then
          echo "âŒ Homebrew is not installed"
          echo "   Install from: https://brew.sh"
          exit 1
        fi
        
        # Install jq if not present
        if ! command -v jq &> /dev/null; then
          echo "Installing jq..."
          brew install jq
        else
          echo "âœ… jq already installed"
        fi
        
        echo "âœ… SBOM dependencies installed"
        echo "   You can now run: task sbom"
