version: "3"
includes:
  sonar:
    taskfile: ./tasks/sonar.yml
    optional: false
  swift:
    taskfile: ./tasks/swift.yml
    optional: false
  security:
    taskfile: ./tasks/security.yml
    optional: false
  markdown:
    taskfile: ./tasks/markdown.yml
    optional: false
  yaml:
    taskfile: ./tasks/yaml.yml
    optional: false
  git:
    taskfile: ./tasks/git.yml
    optional: false
vars:
  HOOKS_PATH: .githooks
  SEMGREP_CONFIG: auto
tasks:
  default:
    desc: Show available tasks
    cmds:
      - |
        echo "ðŸš€ MagSafe Guard Development Tasks"
        echo "=================================="
        echo ""
        echo "ðŸ”§ Core Commands:"
        echo "  task init          - Initialize development environment"
        echo "  task run           - Build and run MagSafe Guard (smart mode)"
        echo "  task run:help      - Show all run command options"
        echo "  task test          - Run all tests"
        echo "  task clean         - Clean build artifacts"
        echo ""
        echo "âœ… Quality Assurance:"
        echo "  task qa            - Run standard QA checks"
        echo "  task qa:quick      - Quick checks (for git hooks)"
        echo "  task qa:fix        - Auto-fix all fixable issues"
        echo "  task qa:full       - Full QA with SonarCloud"
        echo ""
        echo "ðŸ“¦ Module Commands:"
        echo "  task swift:        - Swift development tasks"
        echo "  task security:     - Security scanning tasks"
        echo "  task sonar:        - SonarCloud analysis"
        echo "  task markdown:     - Markdown linting"
        echo "  task yaml:         - YAML validation and linting"
        echo "  task git:          - Git and GitHub tasks"
        echo ""
        echo "ðŸ’¡ Tips:"
        echo "  â€¢ Use 'task <module>:' to see module-specific tasks"
        echo "  â€¢ Use 'task --list' to see all available tasks"
        echo "  â€¢ Most commands have a '--help' option"
        echo ""
    silent: true
  init:
    desc: Initialize development environment
    cmds:
      - task: check-tools
      - task: setup-hooks
      - task: setup
      - task: verify-setup
    silent: true
  setup:
    desc: Install all development tools and dependencies
    cmds:
      - task: swift:setup
      - task: security:setup
      - task: sonar:setup
      - task: markdown:setup
    silent: true
  check-tools:
    # Internal task - checks required development tools
    cmds:
      - |
        echo "ðŸ” Checking development tools..."
        missing_tools=0

        # Check for git
        if ! command -v git &> /dev/null; then
          echo "âŒ git is not installed"
          missing_tools=$((missing_tools + 1))
        else
          echo "âœ… git $(git --version | awk '{print $3}')"
        fi

        # Check for Swift
        if ! command -v swift &> /dev/null; then
          echo "âŒ Swift is not installed"
          missing_tools=$((missing_tools + 1))
        else
          echo "âœ… Swift $(swift --version | head -1 | awk '{print $4}')"
        fi

        # Check for SwiftLint (required)
        if ! command -v swiftlint &> /dev/null; then
          echo "âŒ SwiftLint is not installed"
          missing_tools=$((missing_tools + 1))
        else
          echo "âœ… SwiftLint $(swiftlint version)"
        fi

        # Check for Semgrep (optional)
        if ! command -v semgrep &> /dev/null; then
          echo "âš ï¸  Semgrep not installed (optional but recommended)"
          echo "   Install with: brew install semgrep"
        else
          echo "âœ… Semgrep $(semgrep --version | head -1)"
        fi

        if [ $missing_tools -gt 0 ]; then
          exit 1
        fi
    silent: true
  setup-hooks:
    # Internal task - configures git hooks for development
    vars:
      CURRENT_HOOKS_PATH:
        sh: git config core.hooksPath || echo ""
    status:
      - test "{{.CURRENT_HOOKS_PATH}}" = "{{.HOOKS_PATH}}"
    cmds:
      - |
        echo "ðŸ”§ Setting up MagSafe Guard development environment..."

        # Configure git to use our hooks directory
        git config core.hooksPath {{.HOOKS_PATH}}
        chmod +x {{.HOOKS_PATH}}/* 2>/dev/null || true

        echo "âœ… Git hooks configured"

        # Check if Semgrep is installed
        if command -v semgrep &> /dev/null; then
          echo "âœ… Semgrep is installed (version: $(semgrep --version | head -1))"
        else
          echo "â„¹ï¸  Semgrep not installed (optional but recommended)"
          echo "   To install: brew install semgrep"
          echo "   Pre-commit will still run basic security checks"
        fi

        echo ""
        echo "Git hooks will now:"
        echo "  â€¢ Check for hardcoded secrets in Swift files"
        echo "  â€¢ Detect private key files"
        echo "  â€¢ Prevent committing .env files"
        echo "  â€¢ Run Semgrep scan (if installed)"
        echo "  â€¢ Validate commit message format (Conventional Commits)"
        echo "  â€¢ Block certain words in commit messages"
        echo ""
        echo "To bypass hooks in emergencies: git commit --no-verify"
        echo "To skip Semgrep only: SKIP_SEMGREP=1 git commit"
    silent: true
  verify-setup:
    # Internal task - verifies development setup
    cmds:
      - |
        echo ""
        echo "ðŸŽ‰ Development environment ready!"
        echo ""
        echo "Git hooks installed:"
        hooks_path=$(git config core.hooksPath)
        if [ -n "$hooks_path" ]; then
          echo "  â€¢ Pre-commit: Security scanning"
          echo "  â€¢ Commit-msg: Conventional commits validation"
        fi
        echo ""
        echo "Next steps:"
        echo "  1. Make changes to the code"
        echo "  2. Commit with conventional format: git commit -m 'feat: description'"
        echo "  3. Run 'task test' before pushing"
    silent: true
  test:
    desc: Run all tests
    silent: true
    cmds:
      - task: security:secrets
      - task: swift:test
      - echo "âœ… All tests passed!"
  clean:
    desc: Clean build artifacts (alias for swift:clean)
    silent: true
    cmds:
      - task: swift:clean
  run:
    desc: Build and run MagSafe Guard with intelligent developer mode
    silent: true
    deps: [swift:setup-bundler]
    cmds:
      - |
        # Enhanced run command with automatic handling of permissions and signing
        echo "ðŸš€ MagSafe Guard Developer Run Command"
        echo "====================================="
        echo ""

        # Detect user type and environment
        IS_ADMIN=false
        if groups | grep -q admin; then
          IS_ADMIN=true
        fi

        HAS_SUDO=false
        if sudo -n true 2>/dev/null; then
          HAS_SUDO=true
        fi

        # Check for development certificates
        HAS_DEV_CERT=false
        if security find-identity -v -p codesigning | grep -q "Apple Development"; then
          HAS_DEV_CERT=true
        fi

        # Display environment info
        echo "ðŸ” Environment Detection:"
        echo "  â€¢ User type: $([ "$IS_ADMIN" = true ] && echo "Admin" || echo "Standard") user"
        echo "  â€¢ Sudo access: $([ "$HAS_SUDO" = true ] && echo "Available" || echo "Not available")"
        echo "  â€¢ Dev certificate: $([ "$HAS_DEV_CERT" = true ] && echo "Found" || echo "Not found")"
        echo ""

        # Kill existing instances
        echo "ðŸ”„ Managing existing instances..."
        if pgrep -x "MagSafeGuard" > /dev/null 2>&1; then
          echo "  â€¢ Terminating existing MagSafe Guard processes..."
          killall MagSafeGuard 2>/dev/null || true
          sleep 1
          
          # Force kill if needed
          if pgrep -x "MagSafeGuard" > /dev/null 2>&1; then
            killall -9 MagSafeGuard 2>/dev/null || true
            sleep 0.5
          fi
          echo "  âœ… Previous instances terminated"
        else
          echo "  âœ… No existing instances found"
        fi

        echo ""
        echo "ðŸ”¨ Building MagSafe Guard..."

        # Build with Swift Bundler
        BUNDLER="./swift-bundler"
        if [ ! -f "$BUNDLER" ]; then
          echo "âŒ Swift Bundler not found. Setting up..."
          task swift:setup-bundler
        fi

        # Clean build directory for fresh start
        rm -rf ./.build/bundler/MagSafeGuard.app

        # Build universal binary
        if ! $BUNDLER bundle --configuration release --universal; then
          echo "âŒ Build failed"
          echo ""
          echo "Troubleshooting:"
          echo "  1. Check for Swift syntax errors"
          echo "  2. Run: swift build -c release"
          echo "  3. Check Package.swift dependencies"
          exit 1
        fi

        APP_PATH="./.build/bundler/MagSafeGuard.app"
        APP_PATH_ABS="$(cd "$(dirname "$APP_PATH")" && pwd)/$(basename "$APP_PATH")"

        if [ ! -d "$APP_PATH" ]; then
          echo "âŒ App bundle not found at $APP_PATH"
          exit 1
        fi

        echo "âœ… Build complete"
        echo ""

        # Smart signing strategy
        echo "ðŸ” Code Signing Strategy..."
        SIGNING_SUCCESS=false

        if [ "$SKIP_CODESIGN" = "1" ]; then
          echo "  âš ï¸  Skipping code signing (SKIP_CODESIGN=1)"
        elif [ "$HAS_DEV_CERT" = true ]; then
          echo "  â€¢ Attempting development signing..."
          if ./scripts/sign-app.sh development "$APP_PATH" >/dev/null 2>&1; then
            echo "  âœ… App signed with development certificate"
            SIGNING_SUCCESS=true
          else
            echo "  âš ï¸  Development signing failed"
          fi
        else
          echo "  â€¢ No development certificate found"
          echo "  â€¢ Using ad-hoc signing for local testing..."
          if codesign --force --deep --sign "-" "$APP_PATH" 2>/dev/null; then
            echo "  âœ… Ad-hoc signing applied"
            SIGNING_SUCCESS=true
          else
            echo "  âš ï¸  Ad-hoc signing failed"
          fi
        fi

        # Clear quarantine and extended attributes
        echo ""
        echo "ðŸ§¹ Preparing app for launch..."
        xattr -cr "$APP_PATH" 2>/dev/null || true

        # Smart launch strategy based on user type and signing
        echo ""
        echo "ðŸš€ Launching MagSafe Guard..."
        LAUNCH_SUCCESS=false

        # Strategy 1: Try normal launch first
        if open "$APP_PATH" 2>/dev/null; then
          LAUNCH_SUCCESS=true
          echo "âœ… App launched successfully via macOS Launch Services"
        else
          echo "âš ï¸  Standard launch failed, trying alternative methods..."
          
          # Strategy 2: For admin users with sudo, try to bypass Gatekeeper
          if [ "$IS_ADMIN" = true ] && [ "$HAS_SUDO" = true ]; then
            echo "  â€¢ Attempting Gatekeeper bypass with sudo..."
            sudo spctl --add "$APP_PATH" 2>/dev/null || true
            sudo xattr -d com.apple.quarantine "$APP_PATH" 2>/dev/null || true
            
            if open "$APP_PATH" 2>/dev/null; then
              LAUNCH_SUCCESS=true
              echo "  âœ… App launched after Gatekeeper bypass"
            fi
          fi
          
          # Strategy 3: Direct execution fallback
          if [ "$LAUNCH_SUCCESS" = false ]; then
            echo "  â€¢ Attempting direct execution..."
            
            # Run directly in background
            "$APP_PATH/Contents/MacOS/MagSafeGuard" &
            APP_PID=$!
            
            # Wait for startup
            sleep 2
            
            if kill -0 $APP_PID 2>/dev/null || pgrep -x "MagSafeGuard" > /dev/null; then
              LAUNCH_SUCCESS=true
              echo "  âœ… App running in direct execution mode (PID: $APP_PID)"
              echo ""
              echo "  â„¹ï¸  Direct execution mode notes:"
              echo "     - App runs without full macOS integration"
              echo "     - Some features may be limited"
              echo "     - This is normal for development"
            else
              echo "  âŒ Direct execution failed"
            fi
          fi
        fi

        # If launch failed, provide detailed help
        if [ "$LAUNCH_SUCCESS" = false ]; then
          echo ""
          echo "âŒ Unable to launch MagSafe Guard"
          echo ""
          echo "ðŸ“‹ Diagnostic Information:"
          echo "   - User type: $([ "$IS_ADMIN" = true ] && echo "Admin" || echo "Standard")"
          echo "   - Signing: $([ "$SIGNING_SUCCESS" = true ] && echo "Success" || echo "Failed")"
          echo "   - Gatekeeper: $(spctl -a "$APP_PATH" 2>&1 | head -1)"
          echo ""
          
          if [ "$IS_ADMIN" = false ]; then
            echo "ðŸ”§ For Standard Users:"
            echo ""
            echo "Option 1 - Get admin help (replace 'admin' with your admin username if different):"
            echo "  su - admin -c 'chmod -R 755 \"$APP_PATH_ABS\" && xattr -cr \"$APP_PATH_ABS\"'"
            echo ""
            echo "Option 2 - Run with sudo (requires your password):"
            echo "  sudo xattr -cr \"$APP_PATH_ABS\""
            echo ""
            echo "Option 3 - Use direct mode:"
            echo "  task run:direct"
            echo ""
            echo "Option 4 - Use unsigned mode:"
            echo "  task run:unsigned"
          else
            echo "ðŸ”§ For Admin Users:"
            echo ""
            echo "Try these commands:"
            echo "  1. xattr -cr '$APP_PATH'"
            echo "  2. spctl --add '$APP_PATH'"
            echo "  3. codesign --force --deep --sign - '$APP_PATH'"
            echo ""
            echo "Or check Console.app for crash logs"
          fi
          exit 1
        fi

        # Verify app is running and stable
        echo ""
        echo "ðŸ” Verifying app stability..."

        # Monitor for 3 seconds
        for i in 1 2 3; do
          sleep 1
          if ! pgrep -x "MagSafeGuard" > /dev/null; then
            echo "âŒ App crashed after $i seconds!"
            echo ""
            echo "Check crash logs:"
            echo "  â€¢ Console.app â†’ Crash Reports"
            echo "  â€¢ ~/Library/Logs/DiagnosticReports/"
            exit 1
          fi
        done

        echo "âœ… App is stable and running!"
        echo ""
        echo "ðŸŽ‰ MagSafe Guard is now running in your menu bar!"
        echo ""
        echo "ðŸ’¡ Quick Guide:"
        echo "   â€¢ Look for 'MG' text or shield icon in menu bar"
        echo "   â€¢ Click icon to access menu"
        echo "   â€¢ Select 'Arm' to enable protection"
        echo "   â€¢ To stop: Click icon â†’ 'Quit MagSafe Guard'"
        echo ""
        echo "ðŸ”§ Developer Tips:"
        echo "   â€¢ Run 'task run' again to rebuild and restart"
        echo "   â€¢ Use 'task run:debug' for debug builds"
        echo "   â€¢ Attach Xcode debugger: Debug â†’ Attach to Process â†’ MagSafeGuard"
        echo "   â€¢ View logs: log stream --predicate 'process == \"MagSafeGuard\"'"

  run:sign:
    desc: Build, sign, and run with full code signing (production-like)
    silent: true
    deps: [swift:setup-bundler]
    cmds:
      - |
        echo "ðŸ” Signed Production Run"
        echo "========================"
        echo ""
        echo "This mode uses full code signing for production-like testing"
        echo ""

        # Check for certificates
        echo "ðŸ” Checking available certificates..."
        if security find-identity -v -p codesigning | grep -q "Developer ID"; then
          echo "âœ… Found Developer ID certificate"
          CONFIG="release"
        elif security find-identity -v -p codesigning | grep -q "Apple Development"; then
          echo "âœ… Found Apple Development certificate"
          CONFIG="development"
        else
          echo "âŒ No signing certificates found"
          echo ""
          echo "To create a certificate:"
          echo "  1. Open Xcode â†’ Settings â†’ Accounts"
          echo "  2. Select your Apple ID"
          echo "  3. Click 'Manage Certificates'"
          echo "  4. Click '+' â†’ 'Apple Development'"
          exit 1
        fi

        # Kill existing instances
        if pgrep -x "MagSafeGuard" > /dev/null 2>&1; then
          echo "ðŸ”„ Stopping existing instances..."
          killall MagSafeGuard 2>/dev/null || true
          sleep 1
        fi

        # Build and sign
        echo ""
        echo "ðŸ”¨ Building with Swift Bundler..."
        ./swift-bundler bundle --configuration release --universal

        APP_PATH="./.build/bundler/MagSafeGuard.app"

        echo ""
        echo "ðŸ” Signing with $CONFIG configuration..."
        ./scripts/sign-app.sh "$CONFIG" "$APP_PATH"

        echo ""
        echo "ðŸš€ Launching signed app..."
        open "$APP_PATH"

        sleep 2

        if pgrep -x "MagSafeGuard" > /dev/null; then
          echo ""
          echo "âœ… Signed app running successfully!"
          echo ""
          echo "This version is properly signed and notarization-ready."
        else
          echo "âŒ Failed to launch signed app"
          exit 1
        fi

  run:watch:
    desc: Watch for changes and auto-rebuild/restart (requires fswatch)
    silent: true
    cmds:
      - |
        echo "ðŸ‘€ Watch Mode"
        echo "============="
        echo ""

        # Check for fswatch
        if ! command -v fswatch &> /dev/null; then
          echo "âŒ fswatch not installed"
          echo ""
          echo "Install with: brew install fswatch"
          exit 1
        fi

        echo "Watching for changes in:"
        echo "  â€¢ Sources/"
        echo "  â€¢ Package.swift"
        echo "  â€¢ Resources/"
        echo ""
        echo "Press Ctrl+C to stop"
        echo ""

        # Initial run
        task run:direct

        # Watch for changes
        fswatch -o Sources Package.swift Resources | while read num ; do
          echo ""
          echo "ðŸ“ Changes detected, rebuilding..."
          task run:direct
        done

  run:help:
    desc: Show detailed help for all run commands
    silent: true
    cmds:
      - |
        echo "ðŸš€ MagSafe Guard Run Commands"
        echo "============================="
        echo ""
        echo "Choose the best command for your situation:"
        echo ""
        echo "ðŸ“‹ Main Commands:"
        echo ""
        echo "  task run"
        echo "    â€¢ Smart detection of environment"
        echo "    â€¢ Automatic signing if certificates available"
        echo "    â€¢ Best for most development scenarios"
        echo "    â€¢ Works for both admin and standard users"
        echo ""
        echo "  task run:direct"
        echo "    â€¢ Runs raw executable (no app bundle)"
        echo "    â€¢ Bypasses all macOS security"
        echo "    â€¢ Fastest startup time"
        echo "    â€¢ Best for standard users without admin"
        echo ""
        echo "  task run:unsigned"
        echo "    â€¢ Creates app bundle but skips signing"
        echo "    â€¢ Faster than signed builds"
        echo "    â€¢ May require security bypass"
        echo ""
        echo "  task run:debug"
        echo "    â€¢ Debug build with symbols"
        echo "    â€¢ Enables verbose logging"
        echo "    â€¢ Allows Xcode attachment"
        echo "    â€¢ Best for debugging issues"
        echo ""
        echo "  task run:sign"
        echo "    â€¢ Full code signing"
        echo "    â€¢ Production-like environment"
        echo "    â€¢ Tests signing workflow"
        echo "    â€¢ Requires certificates"
        echo ""
        echo "  task run:watch"
        echo "    â€¢ Auto-rebuild on file changes"
        echo "    â€¢ Great for rapid iteration"
        echo "    â€¢ Requires fswatch installed"
        echo ""
        echo "ðŸ”§ Troubleshooting:"
        echo ""
        echo "  Standard user? â†’ Use 'task run:direct'"
        echo "  Gatekeeper issues? â†’ Use 'task run:direct' or get admin help"
        echo "  Need debugging? â†’ Use 'task run:debug'"
        echo "  Testing signing? â†’ Use 'task run:sign'"
        echo "  Rapid development? â†’ Use 'task run:watch'"
        echo ""
        echo "ðŸ’¡ Pro Tips:"
        echo "  â€¢ 'task run' adapts to your environment automatically"
        echo "  â€¢ Use 'task run:direct' for fastest iteration"
        echo "  â€¢ Debug with: log stream --predicate 'process == \"MagSafeGuard\"'"
        echo "  â€¢ Kill app with: killall MagSafeGuard"

  run:unsigned:
    desc: Build and run MagSafe Guard without code signing (fastest iteration)
    silent: true
    cmds:
      - |
        echo "ðŸš€ Running MagSafe Guard (Unsigned Mode)"
        echo "======================================="
        echo ""
        echo "â„¹ï¸  This mode skips all code signing for fastest iteration"
        echo ""

        # Set environment variable and run
        export SKIP_CODESIGN=1
        task run

  run:direct:
    desc: Run MagSafe Guard executable directly (bypasses all macOS security)
    silent: true
    cmds:
      - |
        echo "ðŸš€ Direct Execution Mode"
        echo "======================="
        echo ""
        echo "This mode runs the raw executable, bypassing:"
        echo "  â€¢ App bundles"
        echo "  â€¢ Code signing"
        echo "  â€¢ Gatekeeper"
        echo "  â€¢ Launch Services"
        echo ""

        # Check for existing build
        EXECUTABLE=".build/release/MagSafeGuard"
        BUILD_AGE=999999

        if [ -f "$EXECUTABLE" ]; then
          # Check if build is recent (within last 5 minutes)
          if [ "$(uname)" = "Darwin" ]; then
            BUILD_TIME=$(stat -f %m "$EXECUTABLE")
            CURRENT_TIME=$(date +%s)
            BUILD_AGE=$((CURRENT_TIME - BUILD_TIME))
          fi
        fi

        # Rebuild if executable is missing or older than 5 minutes
        if [ ! -f "$EXECUTABLE" ] || [ $BUILD_AGE -gt 300 ]; then
          echo "ðŸ”¨ Building MagSafe Guard..."
          swift build -c release --product MagSafeGuard
          
          if [ $? -ne 0 ]; then
            echo "âŒ Build failed"
            exit 1
          fi
        else
          echo "âœ… Using existing build ($(( BUILD_AGE / 60 )) minutes old)"
        fi

        if [ ! -f "$EXECUTABLE" ]; then
          echo "âŒ Executable not found at $EXECUTABLE"
          exit 1
        fi

        echo ""

        # Kill existing instances
        if pgrep -x "MagSafeGuard" > /dev/null 2>&1; then
          echo "ðŸ”„ Stopping existing instances..."
          killall MagSafeGuard 2>/dev/null || true
          sleep 1
          
          # Force kill if needed
          if pgrep -x "MagSafeGuard" > /dev/null 2>&1; then
            killall -9 MagSafeGuard 2>/dev/null || true
          fi
        fi

        echo "ðŸš€ Starting MagSafe Guard (direct mode)..."
        echo ""

        # Clear any extended attributes on the executable
        xattr -cr "$EXECUTABLE" 2>/dev/null || true

        # Run directly with output capture
        "$EXECUTABLE" 2>&1 | tee /tmp/magsafe-guard.log &
        APP_PID=$!

        # Monitor startup
        echo "Waiting for app to initialize..."
        sleep 3

        # Check if running
        if kill -0 $APP_PID 2>/dev/null || pgrep -x "MagSafeGuard" > /dev/null; then
          echo ""
          echo "âœ… MagSafe Guard is running!"
          echo ""
          echo "ðŸ“‹ Runtime Information:"
          echo "   â€¢ Process ID: $APP_PID"
          echo "   â€¢ Log file: /tmp/magsafe-guard.log"
          echo "   â€¢ Executable: $EXECUTABLE"
          echo ""
          echo "ðŸ’¡ Direct Mode Features:"
          echo "   âœ… Full functionality"
          echo "   âœ… No signing required"
          echo "   âœ… Works for all users"
          echo "   âŒ No app bundle (no Finder icon)"
          echo "   âŒ No automatic CloudKit setup"
          echo ""
          echo "ðŸ›‘ To stop: killall MagSafeGuard"
          echo "ðŸ“Š View logs: tail -f /tmp/magsafe-guard.log"
        else
          echo ""
          echo "âŒ App failed to start!"
          echo ""
          echo "Last 20 lines of output:"
          tail -20 /tmp/magsafe-guard.log 2>/dev/null || echo "No log output found"
          echo ""
          echo "Try running manually to see full error:"
          echo "  $EXECUTABLE"
          exit 1
        fi

  build:
    desc: Build MagSafe Guard app bundle using Swift Bundler
    silent: true
    deps: [swift:setup-bundler]
    cmds:
      - |
        echo "ðŸ”¨ Building MagSafe Guard app bundle..."

        # Ensure Swift Bundler is available
        BUNDLER="./swift-bundler"
        if [ ! -f "$BUNDLER" ]; then
          echo "Setting up Swift Bundler..."
          task swift:setup-bundler
        fi

        # Clean previous build
        rm -rf ./.build/bundler/MagSafeGuard.app

        # Build with Swift Bundler
        echo "Building universal binary..."
        if $BUNDLER bundle --configuration release --universal; then
          echo "âœ… Build complete!"
          echo ""
          echo "App bundle: ./.build/bundler/MagSafeGuard.app"
          echo ""
          echo "Next steps:"
          echo "  â€¢ Run the app: task run"
          echo "  â€¢ Sign the app: task swift:sign"
          echo "  â€¢ Create installer: task swift:package"
        else
          echo "âŒ Build failed"
          exit 1
        fi

  run:debug:
    desc: Build and run MagSafe Guard in debug mode with enhanced debugging
    silent: true
    deps: [swift:setup-bundler]
    cmds:
      - |
        echo "ðŸ› Debug Mode Run"
        echo "================="
        echo ""
        echo "This mode enables:"
        echo "  â€¢ Debug symbols"
        echo "  â€¢ Verbose logging"
        echo "  â€¢ Assertion checks"
        echo "  â€¢ Xcode attachment"
        echo ""

        # Kill existing instances
        if pgrep -x "MagSafeGuard" > /dev/null 2>&1; then
          echo "ðŸ”„ Stopping existing instances..."
          killall MagSafeGuard 2>/dev/null || true
          sleep 1
        fi

        echo "ðŸ”¨ Building debug version..."

        # Clean debug build directory
        rm -rf ./.build/bundler/MagSafeGuard.app

        # Build with Swift Bundler in debug mode
        BUNDLER="./swift-bundler"
        if [ ! -f "$BUNDLER" ]; then
          echo "Setting up Swift Bundler..."
          task swift:setup-bundler
        fi

        # Build debug version
        if ! $BUNDLER bundle --configuration debug --universal; then
          echo "âŒ Debug build failed"
          exit 1
        fi

        APP_PATH="./.build/bundler/MagSafeGuard.app"

        if [ ! -d "$APP_PATH" ]; then
          echo "âŒ Debug app bundle not found"
          exit 1
        fi

        echo "âœ… Debug build complete"
        echo ""

        # Apply ad-hoc signing for debug
        echo "ðŸ” Applying debug signing..."
        codesign --force --deep --sign "-" "$APP_PATH" 2>/dev/null || true
        xattr -cr "$APP_PATH" 2>/dev/null || true

        # Enable debug logging
        export MAGSAFE_GUARD_DEBUG=1
        export MAGSAFE_GUARD_LOG_LEVEL=debug

        echo "ðŸš€ Launching in debug mode..."

        # Try normal launch first
        if ! open "$APP_PATH" 2>/dev/null; then
          echo "âš ï¸  Normal launch failed, using direct execution..."
          "$APP_PATH/Contents/MacOS/MagSafeGuard" &
          APP_PID=$!
        fi

        sleep 2

        # Verify it's running
        if pgrep -x "MagSafeGuard" > /dev/null; then
          echo "âœ… Debug version running!"
          echo ""
          echo "ðŸ› Debugging Options:"
          echo ""
          echo "1. Attach with Xcode:"
          echo "   â€¢ Open Xcode"
          echo "   â€¢ Debug â†’ Attach to Process â†’ MagSafeGuard"
          echo ""
          echo "2. View live logs:"
          echo "   log stream --predicate 'process == \"MagSafeGuard\"' --level debug"
          echo ""
          echo "3. View Console.app:"
          echo "   â€¢ Open Console.app"
          echo "   â€¢ Filter by 'MagSafeGuard'"
          echo ""
          echo "4. Debug with lldb:"
          echo "   lldb -n MagSafeGuard"
          echo ""
          echo "ðŸ’¡ Debug build includes:"
          echo "   â€¢ Symbol information for stack traces"
          echo "   â€¢ Assertion failures will crash (good for finding bugs)"
          echo "   â€¢ Verbose logging enabled"
          echo "   â€¢ Optimization disabled for better debugging"
        else
          echo "âŒ Debug launch failed!"
          exit 1
        fi

  qa:
    desc: Run standard quality assurance checks
    silent: true
    cmds:
      - echo "ðŸ”¬ Running standard QA suite..."
      - task: qa:fix
      - task: swift:test:coverage
      - task: swift:lint
      - task: yaml:lint
      - task: markdown:lint
      - task: security:scan
      - task: swift:sbom
      - task: docs:update
      - echo "âœ… Standard QA suite passed!"
  qa:quick:
    desc: Quick QA checks for git hooks
    silent: true
    cmds:
      - echo "âš¡ Running quick QA checks..."
      - task: swift:lint
      - task: yaml:validate
      - task: markdown:lint
      - task: security:secrets
      - echo "âœ… Quick QA checks passed!"
  qa:fix:
    desc: Auto-fix all fixable issues
    silent: true
    cmds:
      - echo "ðŸ”§ Auto-fixing issues..."
      - task: swift:lint:fix
      - task: yaml:lint:fix
      - task: markdown:lint:fix
      - task: markdown:pr:fix
      - echo "âœ… Auto-fix complete!"
  qa:full:
    desc: Full QA suite including SonarCloud analysis
    silent: true
    cmds:
      - echo "ðŸš€ Running full QA suite with SonarCloud..."
      - task: qa
      - task: sonar:scan
      - echo "âœ… Full QA suite with SonarCloud completed!"
  # Aliases for backward compatibility
  pre-push:
    desc: "(Deprecated) Use 'task qa' instead"
    silent: true
    cmds:
      - echo "âš ï¸  'pre-push' is deprecated. Use 'task qa' instead."
      - task: qa
  pre-pr:
    desc: "(Deprecated) Use 'task qa' instead"
    silent: true
    cmds:
      - echo "âš ï¸  'pre-pr' is deprecated. Use 'task qa' instead."
      - task: qa
  commit:
    desc: Interactive commit with conventional format
    silent: true
    cmds:
      - |
        echo "ðŸ“ Creating conventional commit..."
        echo ""
        echo "Select commit type:"
        echo "  1) feat     - New feature"
        echo "  2) fix      - Bug fix"
        echo "  3) docs     - Documentation"
        echo "  4) style    - Code style"
        echo "  5) refactor - Code refactoring"
        echo "  6) test     - Tests"
        echo "  7) chore    - Maintenance"
        echo ""
        read -p "Enter number (1-7): " type_num

        case $type_num in
          1) type="feat";;
          2) type="fix";;
          3) type="docs";;
          4) type="style";;
          5) type="refactor";;
          6) type="test";;
          7) type="chore";;
          *) echo "Invalid selection"; exit 1;;
        esac

        read -p "Enter scope (optional, press enter to skip): " scope
        read -p "Enter commit message: " message

        if [ -n "$scope" ]; then
          commit_msg="${type}(${scope}): ${message}"
        else
          commit_msg="${type}: ${message}"
        fi

        echo ""
        echo "Commit message: $commit_msg"
        read -p "Proceed? (y/n): " confirm

        if [ "$confirm" = "y" ]; then
          git commit -m "$commit_msg"
        else
          echo "Commit cancelled"
        fi
    interactive: true
  docs:update:
    desc: Update TaskMaster progress to main README
    silent: true
    cmds:
      - |
        task-master sync-readme >/dev/null 2>&1
  # Module shortcuts for easy discovery
  "swift:":
    desc: Show Swift development tasks
    silent: true
    cmds:
      - task: swift:default
  "security:":
    desc: Show security scanning tasks
    silent: true
    cmds:
      - task: security:default
  "sonar:":
    desc: Show SonarCloud analysis tasks
    silent: true
    cmds:
      - task: sonar:default
  "markdown:":
    desc: Show markdown linting tasks
    silent: true
    cmds:
      - task: markdown:default
  "yaml:":
    desc: Show YAML validation tasks
    silent: true
    cmds:
      - task: yaml:default
  "git:":
    desc: Show Git and GitHub tasks
    silent: true
    cmds:
      - task: git:default
