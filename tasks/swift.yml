version: "3"

tasks:
  default:
    desc: List all Swift tasks
    silent: true
    cmds:
      - task --list | grep "^\\* swift:" | grep -v "::" || true

  test:
    desc: Run Swift tests
    silent: true
    cmds:
      - |
        echo "🧪 Running Swift tests..."

        # Run tests with --parallel flag to work around initialization hang
        # See: https://github.com/apple/swift/issues/71044
        set +e  # Don't exit on error
        swift test --parallel --num-workers 1 > test-output.log 2>&1
        TEST_EXIT_CODE=$?

        # Display output without standalone numbers that cause shell errors
        grep -v "^[0-9]*$" test-output.log || true

        # Clean up
        rm -f test-output.log

        if [ $TEST_EXIT_CODE -eq 0 ]; then
          echo "✅ All tests passed!"
        else
          echo "❌ Tests failed!"
          exit $TEST_EXIT_CODE
        fi

  test:coverage:
    desc: Run tests with coverage report
    silent: true
    cmds:
      - |
        echo "🧪 Running tests with coverage..."

        # Build test executable with coverage
        swift build --enable-code-coverage

        # Run tests with coverage, capturing output
        # Using --parallel to work around initialization hang
        set +e  # Don't exit on error
        swift test --enable-code-coverage --parallel --num-workers 1 > test-output.log 2>&1
        TEST_EXIT_CODE=$?

        # Check if tests passed based on exit code (more reliable than parsing output)
        if [ $TEST_EXIT_CODE -eq 0 ]; then
          TEST_SUCCESS=true
          echo "✅ Tests passed - generating coverage report..."
        else
          TEST_SUCCESS=false
          echo "⚠️  Some tests failed - still generating coverage report..."
        fi

        # Clean up
        rm -f test-output.log

        # Find the coverage data
        PROF_DATA=$(find .build -name 'default.profdata' -type f | head -1)
        BINARY=$(find .build -name '*.xctest' -type d | head -1)/Contents/MacOS/*

        if [[ -f "$PROF_DATA" ]] && [[ -n "$BINARY" ]]; then
          # Extract just the binary path (without wildcard)
          BINARY=$(find .build -name '*.xctest' -type d | head -1)/Contents/MacOS/$(basename "$(find .build -name '*.xctest' -type d | head -1)" .xctest)
          
          if [[ -f "$BINARY" ]]; then
            echo ""
            echo "📊 Coverage Report:"
            echo "=================="
            
            # Generate report with standard filters for Swift projects
            xcrun llvm-cov report "$BINARY" \
              -instr-profile="$PROF_DATA" \
              -ignore-filename-regex=".*Tests.*|.*Mock.*|.*\.pb\.swift|.*generated.*" \
              -use-color=false | tee coverage-report.txt
            
            # Extract total coverage
            COVERAGE=$(tail -1 coverage-report.txt | awk '{print $(NF-2)}' | sed 's/%//')
            
            echo ""
            if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
              echo "✅ Coverage is ${COVERAGE}% (meets 80% threshold)"
            else
              echo "⚠️  Coverage is ${COVERAGE}% (below 80% threshold)"
              echo ""
              echo "Files with low coverage:"
              grep -E "^\S+\.swift" coverage-report.txt | grep -v "100.00%" | sort -k10 -n | head -10
            fi
          fi
        else
          echo "❌ Coverage data not found"
          exit 1
        fi

        # Exit based on test results
        if [ "$TEST_SUCCESS" = false ]; then
          echo ""
          echo "❌ Tests failed - fix failing tests first"
          exit 1
        fi

  test:html:
    desc: Generate HTML coverage report
    silent: true
    cmds:
      - |
        echo "📊 Generating HTML coverage report..."
        swift test --enable-code-coverage --parallel --num-workers 1

        PROF_DATA=$(find .build -name 'default.profdata' -type f | head -1)
        EXECUTABLE=$(find .build -name '*.xctest' -type d | head -1)/Contents/MacOS/*

        if [[ -f "$PROF_DATA" ]] && [[ -n "$EXECUTABLE" ]]; then
          EXECUTABLE=$(find .build -name '*.xctest' -type d | head -1)/Contents/MacOS/$(basename "$(find .build -name '*.xctest' -type d | head -1)" .xctest)
          
          xcrun llvm-cov show "$EXECUTABLE" \
            -instr-profile="$PROF_DATA" \
            -format=html \
            -output-dir=coverage-html \
            -ignore-filename-regex=".*Tests\.swift|.*Mock.*\.swift|.*\.pb\.swift|.*generated.*"
          
          echo "✅ Coverage report generated at: coverage-html/index.html"
          
          # Open if on macOS
          if [[ "$OSTYPE" == "darwin"* ]]; then
            open coverage-html/index.html
          fi
        else
          echo "❌ Coverage data not found"
          exit 1
        fi

  lint:
    desc: Run SwiftLint
    silent: true
    cmds:
      - |
        echo "🔍 Linting Swift files..."
        if command -v swiftlint &> /dev/null; then
          swiftlint lint --quiet
          if [ $? -eq 0 ]; then
            echo "✅ SwiftLint passed"
          else
            echo "❌ SwiftLint found issues"
            echo ""
            echo "Run 'task swift:lint:fix' to auto-fix what's possible"
            exit 1
          fi
        else
          echo "⚠️  SwiftLint not installed"
          echo "   Install with: brew install swiftlint"
          echo "   Or run: task swift:install:tools"
        fi

  lint:fix:
    desc: Auto-fix SwiftLint issues
    silent: true
    cmds:
      - |
        echo "🔧 Fixing Swift linting issues..."
        if command -v swiftlint &> /dev/null; then
          swiftlint lint --fix --quiet
          if [ $? -eq 0 ]; then
            echo "✅ SwiftLint fixes applied"
          else
            echo "⚠️  Some issues require manual fixing"
            echo ""
            echo "Run 'task swift:lint' to see remaining issues"
          fi
        else
          echo "⚠️  SwiftLint not installed"
          echo "   Install with: brew install swiftlint"
          echo "   Or run: task swift:install:tools"
        fi

  format:
    desc: Format Swift code
    silent: true
    cmds:
      - |
        echo "🎨 Formatting Swift code..."

        # Use swift-format if available
        if command -v swift-format &> /dev/null; then
          swift-format -i -r Sources/ Tests/
          echo "✅ Swift code formatted with swift-format"
        # Fall back to SwiftLint formatting
        elif command -v swiftlint &> /dev/null; then
          swiftlint lint --fix --quiet
          echo "✅ Swift code formatted with SwiftLint"
        else
          echo "⚠️  No Swift formatter installed"
          echo "   Install swift-format: brew install swift-format"
          echo "   Or SwiftLint: brew install swiftlint"
          exit 1
        fi

  clean:
    desc: Clean Swift build artifacts
    silent: true
    cmds:
      - |
        echo "🧹 Cleaning Swift build artifacts..."
        swift package clean
        rm -rf .build
        rm -rf .swiftpm
        rm -f Package.resolved
        echo "✅ Build artifacts cleaned"

  build:
    desc: Build Swift package in debug mode
    silent: true
    cmds:
      - |
        echo "🔨 Building Swift package (debug)..."
        swift build
        if [ $? -eq 0 ]; then
          echo "✅ Build succeeded"
        else
          echo "❌ Build failed"
          exit 1
        fi

  build:release:
    desc: Build Swift package in release mode
    silent: true
    cmds:
      - |
        echo "🔨 Building Swift package (release)..."
        swift build -c release
        if [ $? -eq 0 ]; then
          echo "✅ Build succeeded"
          
          # Show binary location
          BINARY=$(find .build/release -name "$(swift package dump-package | jq -r '.products[] | select(.type.executable != null) | .name' | head -1)" -type f 2>/dev/null | head -1)
          if [ -n "$BINARY" ]; then
            echo "   Binary: $BINARY"
            echo "   Size: $(ls -lh "$BINARY" | awk '{print $5}')"
          fi
        else
          echo "❌ Build failed"
          exit 1
        fi

  deps:
    desc: Show Swift package dependencies
    silent: true
    cmds:
      - |
        echo "📦 Swift Package Dependencies:"
        echo ""
        swift package show-dependencies

  deps:tree:
    desc: Show Swift package dependency tree
    silent: true
    cmds:
      - |
        echo "📦 Swift Package Dependency Tree:"
        echo ""
        swift package show-dependencies --format tree

  update:
    desc: Update Swift package dependencies
    silent: true
    cmds:
      - |
        echo "📦 Updating Swift package dependencies..."
        swift package update
        echo "✅ Dependencies updated"

  resolve:
    desc: Resolve Swift package dependencies
    silent: true
    cmds:
      - |
        echo "📦 Resolving Swift package dependencies..."
        swift package resolve
        echo "✅ Dependencies resolved"

  install:tools:
    desc: Install Swift development tools
    silent: true
    cmds:
      - |
        echo "🔧 Installing Swift development tools..."

        # Detect OS
        OS=$(uname -s | tr '[:upper:]' '[:lower:]')

        if [ "$OS" != "darwin" ]; then
          echo "⚠️  This task is optimized for macOS"
          echo "   For other platforms, please install tools manually"
          exit 0
        fi

        # Check for Homebrew
        if ! command -v brew &> /dev/null; then
          echo "❌ Homebrew not found"
          echo "   Install from: https://brew.sh"
          exit 1
        fi

        # Install SwiftLint
        if ! command -v swiftlint &> /dev/null; then
          echo "📦 Installing SwiftLint..."
          brew install swiftlint
        else
          echo "✅ SwiftLint already installed"
        fi

        # Install swift-format (optional)
        if ! command -v swift-format &> /dev/null; then
          echo "📦 Installing swift-format..."
          brew install swift-format
        else
          echo "✅ swift-format already installed"
        fi

        # Install SwiftGen (optional, for code generation)
        if ! command -v swiftgen &> /dev/null; then
          echo "📦 Installing SwiftGen..."
          brew install swiftgen
        else
          echo "✅ SwiftGen already installed"
        fi

        echo ""
        echo "✅ Swift development tools installed"
        echo ""
        echo "Installed tools:"
        echo "  - SwiftLint: $(swiftlint version)"
        echo "  - swift-format: $(swift-format --version 2>&1 | head -1)"
        echo "  - SwiftGen: $(swiftgen --version 2>&1 | head -1)"

  docs:
    desc: Generate Swift API documentation using Swift-DocC
    silent: true
    vars:
      OUTPUT_PATH: '{{.OUTPUT_PATH | default "docs/api"}}'
    cmds:
      - |
        echo "📚 Generating Swift API documentation..."

        # Ensure output directory exists
        mkdir -p {{.OUTPUT_PATH}}

        # Check if we're in a Swift package
        if [ ! -f "Package.swift" ]; then
          echo "❌ Not a Swift package. Package.swift not found."
          exit 1
        fi

        # Get package name
        PACKAGE_NAME=$(swift package dump-package | jq -r '.name')

        # Check Swift version for DocC support (5.5+)
        SWIFT_VERSION=$(swift --version | grep -oE '[0-9]+\.[0-9]+' | head -1)
        MAJOR_VERSION=$(echo $SWIFT_VERSION | cut -d. -f1)
        MINOR_VERSION=$(echo $SWIFT_VERSION | cut -d. -f2)

        if [ "$MAJOR_VERSION" -lt 5 ] || ([ "$MAJOR_VERSION" -eq 5 ] && [ "$MINOR_VERSION" -lt 5 ]); then
          echo "⚠️  Swift-DocC requires Swift 5.5 or later. Current version: $SWIFT_VERSION"
          echo ""
          echo "Alternative: Install and use jazzy or swift-doc:"
          echo "  gem install jazzy"
          echo "  brew install swiftdocorg/formulae/swift-doc"
          exit 1
        fi

        echo "🔨 Building documentation for $PACKAGE_NAME..."

        # Generate documentation
        if swift package generate-documentation \
          --target MagSafeGuard \
          --disable-indexing \
          --transform-for-static-hosting \
          --hosting-base-path "/$PACKAGE_NAME" \
          --output-path {{.OUTPUT_PATH}} 2>/dev/null; then
          
          echo "✅ Documentation generated successfully!"
          echo ""
          echo "📂 Output location: {{.OUTPUT_PATH}}"
          echo ""
          echo "To view locally:"
          echo "  1. cd {{.OUTPUT_PATH}}"
          echo "  2. python3 -m http.server 8000"
          echo "  3. Open http://localhost:8000/documentation/$PACKAGE_NAME"
          echo ""
          echo "To preview with live updates:"
          echo "  swift package --disable-sandbox preview-documentation --target MagSafeGuard"
          
        else
          # Fallback to simpler generation without static hosting
          echo "⚠️  Static hosting generation failed, trying simple generation..."
          
          if swift package generate-documentation --target MagSafeGuard --output-path {{.OUTPUT_PATH}}; then
            echo "✅ Documentation generated (without static hosting transforms)"
            echo "📂 Output location: {{.OUTPUT_PATH}}"
          else
            echo "❌ Documentation generation failed"
            echo ""
            echo "Common issues:"
            echo "  - Missing documentation comments (use /// or /** */)"
            echo "  - Build errors in the code"
            echo "  - Missing target specification"
            echo ""
            echo "Try building first: swift build"
            exit 1
          fi
        fi

  outdated:
    desc: Check for outdated Swift dependencies
    silent: true
    cmds:
      - |
        echo "🔍 Checking for outdated dependencies..."

        # This is a basic implementation since Swift PM doesn't have built-in outdated check
        echo "Current dependencies:"
        swift package show-dependencies --format json | jq -r '.dependencies[] | "\(.name) @ \(.version // "unresolved")"'

        echo ""
        echo "To update all dependencies, run: task swift:update"

  sbom:
    desc: Generate Software Bill of Materials (SBOM) in SPDX format
    silent: true
    cmds:
      - |
        echo "📦 Generating SBOM for Swift project..."

        # Get package info
        PACKAGE_NAME=$(swift package dump-package | jq -r '.name')
        VERSION=$(git describe --tags --always 2>/dev/null || echo "1.0.0")
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

        # Create SPDX SBOM
        echo "SPDXVersion: SPDX-2.3" > sbom.spdx
        echo "DataLicense: CC0-1.0" >> sbom.spdx
        echo "SPDXID: SPDXRef-DOCUMENT" >> sbom.spdx
        echo "DocumentName: ${PACKAGE_NAME}" >> sbom.spdx
        echo "DocumentNamespace: https://sbom.swift/${PACKAGE_NAME}/spdx-${VERSION}-$(date +%s)" >> sbom.spdx
        echo "Creator: Tool: swift-package-sbom-1.0.0" >> sbom.spdx
        echo "Created: ${TIMESTAMP}" >> sbom.spdx
        echo "" >> sbom.spdx

        # Package information
        echo "PackageName: ${PACKAGE_NAME}" >> sbom.spdx
        echo "SPDXID: SPDXRef-Package-${PACKAGE_NAME}" >> sbom.spdx
        echo "PackageVersion: ${VERSION}" >> sbom.spdx
        echo "PackageSupplier: Organization: Swift Package" >> sbom.spdx
        echo "PackageDownloadLocation: NOASSERTION" >> sbom.spdx
        echo "FilesAnalyzed: true" >> sbom.spdx
        echo "PackageVerificationCode: NOASSERTION" >> sbom.spdx
        echo "PackageLicenseConcluded: NOASSERTION" >> sbom.spdx
        echo "PackageLicenseDeclared: NOASSERTION" >> sbom.spdx
        echo "PackageCopyrightText: NOASSERTION" >> sbom.spdx
        echo "" >> sbom.spdx

        # Dependencies
        echo "" >> sbom.spdx
        echo "# Dependencies" >> sbom.spdx
        DEPS=$(swift package show-dependencies --format json | jq -r '.dependencies[]? | "PackageName: " + .name + "\nSPDXID: SPDXRef-Package-" + .identity + "\nPackageVersion: " + (.version // "unknown") + "\nPackageDownloadLocation: " + (.url // "NOASSERTION") + "\nFilesAnalyzed: false\nPackageLicenseConcluded: NOASSERTION\nPackageLicenseDeclared: NOASSERTION\nPackageCopyrightText: NOASSERTION\n\nRelationship: SPDXRef-Package-" + .identity + " DEPENDENCY_OF SPDXRef-Package-${PACKAGE_NAME}\n"' 2>/dev/null || echo "")

        if [ -n "$DEPS" ]; then
          echo "$DEPS" >> sbom.spdx
        fi

        echo "✅ Generated: sbom.spdx"
        echo "   Project: ${PACKAGE_NAME} v${VERSION}"

        # Also generate in JSON format
        swift package show-dependencies --format json > sbom-deps.json

        echo "✅ Also generated: sbom-deps.json (Swift dependencies)"
    sources:
      - Package.swift
      - Sources/**/*.swift
    generates:
      - sbom.spdx
      - sbom-deps.json
