version: "3"

tasks:
  default:
    desc: List all Swift tasks
    silent: true
    cmds:
      - task --list | grep "^\\* swift:" | grep -v "::" || true

  test:
    desc: Run Swift tests
    silent: true
    cmds:
      - |
        echo "ðŸ§ª Running Swift tests..."

        # Run tests with --parallel flag to work around initialization hang
        # See: https://github.com/apple/swift/issues/71044
        set +e  # Don't exit on error
        swift test --parallel --num-workers 1 > test-output.log 2>&1
        TEST_EXIT_CODE=$?

        # Display output without standalone numbers that cause shell errors
        grep -v "^[0-9]*$" test-output.log || true

        # Clean up
        rm -f test-output.log

        if [ $TEST_EXIT_CODE -eq 0 ]; then
          echo "âœ… All tests passed!"
        else
          echo "âŒ Tests failed!"
          exit $TEST_EXIT_CODE
        fi

  test:coverage:
    desc: Run tests with coverage report
    silent: true
    cmds:
      - |
        echo "ðŸ§ª Running tests with coverage..."

        # Build test executable with coverage
        swift build --enable-code-coverage

        # Run tests with coverage, capturing output
        # Using --parallel to work around initialization hang
        set +e  # Don't exit on error
        swift test --enable-code-coverage --parallel --num-workers 1 > test-output.log 2>&1
        TEST_EXIT_CODE=$?

        # Check if tests passed based on exit code (more reliable than parsing output)
        if [ $TEST_EXIT_CODE -eq 0 ]; then
          TEST_SUCCESS=true
          echo "âœ… Tests passed - generating coverage report..."
        else
          TEST_SUCCESS=false
          echo "âš ï¸  Some tests failed - still generating coverage report..."
        fi

        # Clean up
        rm -f test-output.log

        # Find the coverage data
        PROF_DATA=$(find .build -name 'default.profdata' -type f | head -1)
        BINARY=$(find .build -name '*.xctest' -type d | head -1)/Contents/MacOS/*

        if [[ -f "$PROF_DATA" ]] && [[ -n "$BINARY" ]]; then
          # Extract just the binary path (without wildcard)
          BINARY=$(find .build -name '*.xctest' -type d | head -1)/Contents/MacOS/$(basename "$(find .build -name '*.xctest' -type d | head -1)" .xctest)
          
          if [[ -f "$BINARY" ]]; then
            echo ""
            echo "ðŸ“Š Coverage Report:"
            echo "=================="
            
            # Generate report with comprehensive filters matching CI
            xcrun llvm-cov report "$BINARY" \
              -instr-profile="$PROF_DATA" \
              -ignore-filename-regex=".*Tests/.*|.*Tests\.swift|.*Mocks?\.swift|.*/MagSafeGuardApp\.swift|.*/SettingsView\.swift|.*/TrustedLocationsView\.swift|.*/PowerMonitorService\.swift|.*LAContext\.swift|.*/MacSystemActions\.swift|.*Protocol\.swift|.*/runner\.swift" \
              -use-color=false | tee coverage-report.txt
            
            # Extract total coverage - look for the TOTAL line
            COVERAGE=$(grep "^TOTAL" coverage-report.txt | awk '{print $10}' | sed 's/%//')
            
            echo ""
            if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
              echo "âœ… Coverage is ${COVERAGE}% (meets 80% threshold)"
            else
              echo "âš ï¸  Coverage is ${COVERAGE}% (below 80% threshold)"
              echo ""
              echo "Files with low coverage:"
              grep -E "^\S+\.swift" coverage-report.txt | grep -v "100.00%" | sort -k10 -n | head -10
            fi
          fi
        else
          echo "âŒ Coverage data not found"
          exit 1
        fi

        # Exit based on test results
        if [ "$TEST_SUCCESS" = false ]; then
          echo ""
          echo "âŒ Tests failed - fix failing tests first"
          exit 1
        fi

  test:html:
    desc: Generate HTML coverage report
    silent: true
    cmds:
      - |
        echo "ðŸ“Š Generating HTML coverage report..."
        swift test --enable-code-coverage --parallel --num-workers 1

        PROF_DATA=$(find .build -name 'default.profdata' -type f | head -1)
        EXECUTABLE=$(find .build -name '*.xctest' -type d | head -1)/Contents/MacOS/*

        if [[ -f "$PROF_DATA" ]] && [[ -n "$EXECUTABLE" ]]; then
          EXECUTABLE=$(find .build -name '*.xctest' -type d | head -1)/Contents/MacOS/$(basename "$(find .build -name '*.xctest' -type d | head -1)" .xctest)
          
          xcrun llvm-cov show "$EXECUTABLE" \
            -instr-profile="$PROF_DATA" \
            -format=html \
            -output-dir=coverage-html \
            -ignore-filename-regex=".*Tests\.swift|.*Mocks?\.swift|.*/MagSafeGuardApp\.swift|.*/SettingsView\.swift|.*/TrustedLocationsView\.swift|.*/PowerMonitorService\.swift|.*LAContext\.swift|.*/MacSystemActions\.swift|.*Protocol\.swift"
          
          echo "âœ… Coverage report generated at: coverage-html/index.html"
          
          # Open if on macOS
          if [[ "$OSTYPE" == "darwin"* ]]; then
            open coverage-html/index.html
          fi
        else
          echo "âŒ Coverage data not found"
          exit 1
        fi

  lint:
    desc: Run SwiftLint
    silent: true
    cmds:
      - |
        echo "ðŸ” Linting Swift files..."
        if command -v swiftlint &> /dev/null; then
          swiftlint lint --quiet
          if [ $? -eq 0 ]; then
            echo "âœ… SwiftLint passed"
          else
            echo "âŒ SwiftLint found issues"
            echo ""
            echo "Run 'task swift:lint:fix' to auto-fix what's possible"
            exit 1
          fi
        else
          echo "âš ï¸  SwiftLint not installed"
          echo "   Install with: brew install swiftlint"
          echo "   Or run: task swift:setup"
        fi

  lint:fix:
    desc: Auto-fix SwiftLint issues
    silent: true
    cmds:
      - |
        echo "ðŸ”§ Fixing Swift linting issues..."
        if command -v swiftlint &> /dev/null; then
          swiftlint lint --fix --quiet
          if [ $? -eq 0 ]; then
            echo "âœ… SwiftLint fixes applied"
          else
            echo "âš ï¸  Some issues require manual fixing"
            echo ""
            echo "Run 'task swift:lint' to see remaining issues"
          fi
        else
          echo "âš ï¸  SwiftLint not installed"
          echo "   Install with: brew install swiftlint"
          echo "   Or run: task swift:setup"
        fi

  format:
    desc: Format Swift code
    silent: true
    cmds:
      - |
        echo "ðŸŽ¨ Formatting Swift code..."

        # Use swift-format if available
        if command -v swift-format &> /dev/null; then
          swift-format -i -r Sources/ Tests/
          echo "âœ… Swift code formatted with swift-format"
        # Fall back to SwiftLint formatting
        elif command -v swiftlint &> /dev/null; then
          swiftlint lint --fix --quiet
          echo "âœ… Swift code formatted with SwiftLint"
        else
          echo "âš ï¸  No Swift formatter installed"
          echo "   Install swift-format: brew install swift-format"
          echo "   Or SwiftLint: brew install swiftlint"
          exit 1
        fi

  clean:
    desc: Clean Swift build artifacts
    silent: true
    cmds:
      - |
        echo "ðŸ§¹ Cleaning Swift build artifacts..."
        swift package clean
        rm -rf .build
        rm -rf .swiftpm
        rm -f Package.resolved
        echo "âœ… Build artifacts cleaned"

  build:
    desc: Build Swift package in debug mode
    silent: true
    cmds:
      - |
        echo "ðŸ”¨ Building Swift package (debug)..."
        swift build
        if [ $? -eq 0 ]; then
          echo "âœ… Build succeeded"
        else
          echo "âŒ Build failed"
          exit 1
        fi

  build:release:
    desc: Build Swift package in release mode
    silent: true
    cmds:
      - |
        echo "ðŸ”¨ Building Swift package (release)..."
        swift build -c release
        if [ $? -eq 0 ]; then
          echo "âœ… Build succeeded"
          
          # Show binary location
          BINARY=$(find .build/release -name "$(swift package dump-package | jq -r '.products[] | select(.type.executable != null) | .name' | head -1)" -type f 2>/dev/null | head -1)
          if [ -n "$BINARY" ]; then
            echo "   Binary: $BINARY"
            echo "   Size: $(ls -lh "$BINARY" | awk '{print $5}')"
          fi
        else
          echo "âŒ Build failed"
          exit 1
        fi

  deps:
    desc: Show Swift package dependencies
    silent: true
    cmds:
      - |
        echo "ðŸ“¦ Swift Package Dependencies:"
        echo ""
        swift package show-dependencies

  deps:tree:
    desc: Show Swift package dependency tree
    silent: true
    cmds:
      - |
        echo "ðŸ“¦ Swift Package Dependency Tree:"
        echo ""
        swift package show-dependencies --format tree

  update:
    desc: Update Swift package dependencies
    silent: true
    cmds:
      - |
        echo "ðŸ“¦ Updating Swift package dependencies..."
        swift package update
        echo "âœ… Dependencies updated"

  resolve:
    desc: Resolve Swift package dependencies
    silent: true
    cmds:
      - |
        echo "ðŸ“¦ Resolving Swift package dependencies..."
        swift package resolve
        echo "âœ… Dependencies resolved"

  setup:
    desc: Setup Swift development tools
    silent: true
    cmds:
      - |
        echo "ðŸ”§ Installing Swift development tools..."

        # Detect OS
        OS=$(uname -s | tr '[:upper:]' '[:lower:]')

        if [ "$OS" != "darwin" ]; then
          echo "âš ï¸  This task is optimized for macOS"
          echo "   For other platforms, please install tools manually"
          exit 0
        fi

        # Check for Homebrew
        if ! command -v brew &> /dev/null; then
          echo "âŒ Homebrew not found"
          echo "   Install from: https://brew.sh"
          exit 1
        fi

        # Install/Update SwiftLint
        if ! command -v swiftlint &> /dev/null; then
          echo "ðŸ“¦ Installing SwiftLint..."
          brew install swiftlint
        else
          echo "âœ… SwiftLint already installed ($(swiftlint version))"
          if brew outdated | grep -q "^swiftlint"; then
            echo "ðŸ“¦ Updating SwiftLint..."
            brew upgrade swiftlint
          fi
        fi

        # Install/Update swift-format (optional)
        if ! command -v swift-format &> /dev/null; then
          echo "ðŸ“¦ Installing swift-format..."
          brew install swift-format
        else
          echo "âœ… swift-format already installed"
          if brew outdated | grep -q "^swift-format"; then
            echo "ðŸ“¦ Updating swift-format..."
            brew upgrade swift-format
          fi
        fi

        # Install/Update SwiftGen (optional, for code generation)
        if ! command -v swiftgen &> /dev/null; then
          echo "ðŸ“¦ Installing SwiftGen..."
          brew install swiftgen
        else
          echo "âœ… SwiftGen already installed"
          if brew outdated | grep -q "^swiftgen"; then
            echo "ðŸ“¦ Updating SwiftGen..."
            brew upgrade swiftgen
          fi
        fi

        # Install/Update jazzy (for documentation generation)
        if ! command -v jazzy &> /dev/null; then
          echo "ðŸ“¦ Installing jazzy to user directory..."
          
          # Check Ruby version first
          RUBY_VERSION=$(ruby -v | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          MIN_VERSION="2.7.0"
          
          if [ "$(printf '%s\n' "$MIN_VERSION" "$RUBY_VERSION" | sort -V | head -n1)" != "$MIN_VERSION" ]; then
            echo "âš ï¸  Ruby version $RUBY_VERSION is too old for jazzy"
            echo "   jazzy requires Ruby >= 2.7"
            echo ""
            echo "To fix this:"
            echo "1. Update Ruby using rbenv or rvm:"
            echo "   brew install rbenv && rbenv install 3.2.2"
            echo ""
            echo "2. Or use system Ruby on macOS 12.3+:"
            echo "   /usr/bin/ruby --version"
            echo ""
            echo "Continuing without jazzy..."
          else
            # Try to install rouge dependency first if needed
            echo "Installing jazzy dependencies..."
            gem install rouge -v 3.30.0 --user-install 2>/dev/null || true
            
            # Install to user directory by default (no admin needed)
            if gem install jazzy --user-install; then
              echo "âœ… jazzy installed successfully to user directory"
              
              # Get the gem bin path
              GEM_BIN_PATH=$(ruby -r rubygems -e 'puts Gem.user_dir')/bin
              
              # Check if it's in PATH
              if [[ ":$PATH:" != *":$GEM_BIN_PATH:"* ]]; then
                echo ""
                echo "âš ï¸  Add the following to your shell profile (.bashrc, .zshrc, etc.):"
                echo "   export PATH=\"$GEM_BIN_PATH:\$PATH\""
                echo ""
                echo "Then reload your shell or run: source ~/.zshrc"
              fi
            else
              echo "âŒ Failed to install jazzy"
              echo ""
              echo "If you see a rouge dependency error, try:"
              echo "  gem install rouge -v 3.30.0 --user-install"
              echo "  gem install jazzy --user-install"
              echo ""
              echo "Alternative installation methods:"
              echo "1. System-wide with sudo (requires admin):"
              echo "   sudo gem install jazzy"
              echo ""
              echo "2. Using su with admin account:"
              echo "   su - admin -c 'gem install jazzy'"
              echo ""
              echo "Continuing without jazzy..."
            fi
          fi
        else
          echo "âœ… jazzy already installed ($(jazzy --version 2>&1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1))"
          # Check if jazzy needs update
          CURRENT_VERSION=$(jazzy --version 2>&1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          LATEST_VERSION=$(gem search ^jazzy$ -r | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ] && [ -n "$LATEST_VERSION" ]; then
            echo "ðŸ“¦ Update available: $CURRENT_VERSION â†’ $LATEST_VERSION"
            echo "   Run 'gem update jazzy' to update"
          fi
        fi

        echo ""
        echo "âœ… Swift development tools installed"
        echo ""
        echo "Installed tools:"
        echo "  - SwiftLint: $(swiftlint version)"
        echo "  - swift-format: $(swift-format --version 2>&1 | head -1)"
        echo "  - SwiftGen: $(swiftgen --version 2>&1 | head -1)"
        echo "  - jazzy: $(jazzy --version 2>&1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)"

  docs:
    desc: Generate Swift API documentation
    silent: true
    vars:
      OUTPUT_PATH: '{{.OUTPUT_PATH | default "docs/api"}}'
    cmds:
      - |
        echo "ðŸ“š Generating Swift API documentation..."
        
        # Ensure output directory exists
        mkdir -p {{.OUTPUT_PATH}}
        
        # Check if we're in a Swift package
        if [ ! -f "Package.swift" ]; then
          echo "âŒ Not a Swift package. Package.swift not found."
          exit 1
        fi
        
        # Get package name
        PACKAGE_NAME=$(swift package dump-package | jq -r '.name')
        
        echo "ðŸ” Checking available documentation tools..."
        
        # Option 1: Try jazzy if installed (most reliable)
        if command -v jazzy &> /dev/null; then
          echo "âœ… Found jazzy - generating documentation..."
          
          jazzy \
            --clean \
            --author "MagSafe Guard" \
            --module MagSafeGuard \
            --source-directory Sources \
            --output {{.OUTPUT_PATH}} \
            --theme apple \
            --documentation "*.md" \
            --readme README.md
            
          if [ $? -eq 0 ]; then
            echo "âœ… Documentation generated successfully!"
            echo "ðŸ“‚ Output location: {{.OUTPUT_PATH}}"
            echo ""
            echo "To view: open {{.OUTPUT_PATH}}/index.html"
          else
            echo "âŒ Jazzy generation failed"
            exit 1
          fi
          
        # Option 2: Try swift-doc if installed
        elif command -v swift-doc &> /dev/null; then
          echo "âœ… Found swift-doc - generating documentation..."
          
          swift-doc generate Sources/MagSafeGuard \
            --module-name MagSafeGuard \
            --output {{.OUTPUT_PATH}} \
            --format html
            
          if [ $? -eq 0 ]; then
            echo "âœ… Documentation generated successfully!"
            echo "ðŸ“‚ Output location: {{.OUTPUT_PATH}}"
            echo ""
            echo "To view: open {{.OUTPUT_PATH}}/index.html"
          else
            echo "âŒ swift-doc generation failed"
            exit 1
          fi
          
        # Option 3: Check if in Xcode environment
        elif command -v xcodebuild &> /dev/null && [ -d "MagSafeGuard.xcodeproj" ]; then
          echo "âœ… Found Xcode - attempting to generate documentation..."
          echo ""
          echo "Note: Xcode documentation generation requires manual steps:"
          echo "  1. Open MagSafeGuard.xcodeproj in Xcode"
          echo "  2. Product â†’ Build Documentation"
          echo "  3. Right-click on MagSafeGuard in documentation window"
          echo "  4. Export Documentation..."
          echo ""
          echo "For now, building project to ensure it compiles..."
          xcodebuild -scheme MagSafeGuard -configuration Release build
          
        else
          # No documentation tool found
          echo "âŒ No documentation generator found!"
          echo ""
          echo "Please install one of the following:"
          echo ""
          echo "Option 1: Jazzy (Recommended)"
          
          # Check Ruby version
          RUBY_VERSION=$(ruby -v | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          MIN_VERSION="2.7.0"
          
          if [ "$(printf '%s\n' "$MIN_VERSION" "$RUBY_VERSION" | sort -V | head -n1)" != "$MIN_VERSION" ]; then
            echo "  âš ï¸  Your Ruby version ($RUBY_VERSION) is too old for jazzy (requires >= 2.7)"
            echo ""
            echo "  First update Ruby:"
            echo "    brew install rbenv && rbenv install 3.2.2"
            echo "    OR use system Ruby: /usr/bin/ruby (macOS 12.3+)"
          else
            echo "  gem install jazzy --user-install"
            echo ""
            echo "  This installs to your user directory (no admin needed)."
            echo "  You may need to add the gem bin directory to your PATH:"
            echo "     export PATH=\"$(ruby -r rubygems -e 'puts Gem.user_dir')/bin:\$PATH\""
            echo ""
            echo "  If you get a rouge dependency error:"
            echo "     gem install rouge -v 3.30.0 --user-install"
            echo "     gem install jazzy --user-install"
            echo ""
            echo "  Alternative installation methods:"
            echo "  a) System-wide with sudo (requires admin):"
            echo "     sudo gem install jazzy"
            echo ""
            echo "  b) Using su with admin account:"
            echo "     su - admin -c 'gem install jazzy'"
            echo "     (replace 'admin' with your admin username)"
          fi
          echo ""
          echo "Option 2: swift-doc"
          echo "  brew install swiftdocorg/formulae/swift-doc"
          echo ""
          echo "Option 3: Use Xcode"
          echo "  Open the project in Xcode and use Product â†’ Build Documentation"
          echo ""
          echo "Note: Swift 6.0+ requires external tools for documentation generation."
          echo "The 'swift package generate-documentation' command has been removed."
          exit 1
        fi

  outdated:
    desc: Check for outdated Swift dependencies
    silent: true
    cmds:
      - |
        echo "ðŸ” Checking for outdated dependencies..."

        # This is a basic implementation since Swift PM doesn't have built-in outdated check
        echo "Current dependencies:"
        swift package show-dependencies --format json | jq -r '.dependencies[] | "\(.name) @ \(.version // "unresolved")"'

        echo ""
        echo "To update all dependencies, run: task swift:update"

  sbom:
    desc: Generate Software Bill of Materials (SBOM) in SPDX format
    silent: true
    cmds:
      - |
        echo "ðŸ“¦ Generating SBOM for Swift project..."

        # Get package info
        PACKAGE_NAME=$(swift package dump-package | jq -r '.name')
        VERSION=$(git describe --tags --always 2>/dev/null || echo "1.0.0")
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

        # Create SPDX SBOM
        echo "SPDXVersion: SPDX-2.3" > sbom.spdx
        echo "DataLicense: CC0-1.0" >> sbom.spdx
        echo "SPDXID: SPDXRef-DOCUMENT" >> sbom.spdx
        echo "DocumentName: ${PACKAGE_NAME}" >> sbom.spdx
        echo "DocumentNamespace: https://sbom.swift/${PACKAGE_NAME}/spdx-${VERSION}-$(date +%s)" >> sbom.spdx
        echo "Creator: Tool: swift-package-sbom-1.0.0" >> sbom.spdx
        echo "Created: ${TIMESTAMP}" >> sbom.spdx
        echo "" >> sbom.spdx

        # Package information
        echo "PackageName: ${PACKAGE_NAME}" >> sbom.spdx
        echo "SPDXID: SPDXRef-Package-${PACKAGE_NAME}" >> sbom.spdx
        echo "PackageVersion: ${VERSION}" >> sbom.spdx
        echo "PackageSupplier: Organization: Swift Package" >> sbom.spdx
        echo "PackageDownloadLocation: NOASSERTION" >> sbom.spdx
        echo "FilesAnalyzed: true" >> sbom.spdx
        echo "PackageVerificationCode: NOASSERTION" >> sbom.spdx
        echo "PackageLicenseConcluded: NOASSERTION" >> sbom.spdx
        echo "PackageLicenseDeclared: NOASSERTION" >> sbom.spdx
        echo "PackageCopyrightText: NOASSERTION" >> sbom.spdx
        echo "" >> sbom.spdx

        # Dependencies
        echo "" >> sbom.spdx
        echo "# Dependencies" >> sbom.spdx
        DEPS=$(swift package show-dependencies --format json | jq -r '.dependencies[]? | "PackageName: " + .name + "\nSPDXID: SPDXRef-Package-" + .identity + "\nPackageVersion: " + (.version // "unknown") + "\nPackageDownloadLocation: " + (.url // "NOASSERTION") + "\nFilesAnalyzed: false\nPackageLicenseConcluded: NOASSERTION\nPackageLicenseDeclared: NOASSERTION\nPackageCopyrightText: NOASSERTION\n\nRelationship: SPDXRef-Package-" + .identity + " DEPENDENCY_OF SPDXRef-Package-${PACKAGE_NAME}\n"' 2>/dev/null || echo "")

        if [ -n "$DEPS" ]; then
          echo "$DEPS" >> sbom.spdx
        fi

        echo "âœ… Generated: sbom.spdx"
        echo "   Project: ${PACKAGE_NAME} v${VERSION}"

        # Also generate in JSON format
        swift package show-dependencies --format json > sbom-deps.json

        echo "âœ… Also generated: sbom-deps.json (Swift dependencies)"
    sources:
      - Package.swift
      - Sources/**/*.swift
    generates:
      - sbom.spdx
      - sbom-deps.json
