version: "3"

tasks:
  default:
    desc: List available Markdown tasks
    silent: true
    cmds:
      - task --list | grep "^\\* markdown:" | grep -v "::" || true

  lint:
    desc: Lint Markdown files
    silent: true
    cmds:
      - |
        echo "üîç Linting Markdown files..."

        # Check if markdownlint is installed
        if ! command -v markdownlint &> /dev/null; then
          echo "‚ö†Ô∏è  markdownlint not installed"
          echo "   Run: task markdown:setup"
          exit 1
        fi

        # Run the linter
        if markdownlint '**/*.md' --ignore node_modules --ignore .build; then
          echo "‚úÖ Markdown lint passed"
        else
          echo "‚ùå Markdown lint found issues"
          echo ""
          echo "Run 'task markdown:lint:fix' to auto-fix what's possible"
          exit 1
        fi

  lint:fix:
    desc: Fix Markdown formatting issues automatically
    silent: true
    cmds:
      - |
        echo "üîß Fixing Markdown formatting issues..."

        # Check if markdownlint is installed
        if ! command -v markdownlint &> /dev/null; then
          echo "‚ö†Ô∏è  markdownlint not installed"
          echo "   Run: task markdown:setup"
          exit 1
        fi

        # Fix all markdown files
        echo "Running markdown formatter..."
        markdownlint '**/*.md' --ignore node_modules --ignore .build --fix
        echo "‚úÖ Markdown files formatted"

        # Show which files were modified
        echo ""
        echo "Modified files:"
        git diff --name-only | grep '\.md$' || echo "  No changes needed"

  setup:
    desc: Setup markdownlint CLI tool
    silent: true
    cmds:
      - |
        echo "üîß Setting up markdownlint..."
        
        # Detect OS
        OS=$(uname -s | tr '[:upper:]' '[:lower:]')
        
        if [ "$OS" != "darwin" ]; then
          echo "‚ö†Ô∏è  This task is optimized for macOS"
          echo "   For other platforms, please install markdownlint manually"
          exit 0
        fi
        
        # Check if already installed
        if command -v markdownlint &> /dev/null; then
          echo "‚úÖ markdownlint is already installed ($(markdownlint --version))"
          
          # Check for updates
          if command -v npm &> /dev/null && npm list -g markdownlint-cli &>/dev/null; then
            CURRENT_VERSION=$(markdownlint --version | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
            LATEST_VERSION=$(npm view markdownlint-cli version 2>/dev/null)
            if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ] && [ -n "$LATEST_VERSION" ]; then
              echo "üì¶ Update available: $CURRENT_VERSION ‚Üí $LATEST_VERSION"
              echo "   Updating markdownlint..."
              npm update -g markdownlint-cli
            fi
          elif command -v brew &> /dev/null && brew list markdownlint-cli &>/dev/null; then
            if brew outdated | grep -q "^markdownlint-cli"; then
              echo "üì¶ Updating markdownlint..."
              brew upgrade markdownlint-cli
            fi
          fi
          exit 0
        fi
        
        # Try to install with npm first (most universal)
        if command -v npm &> /dev/null; then
          echo "üì¶ Installing markdownlint with npm..."
          if npm install -g markdownlint-cli 2>/dev/null; then
            echo "‚úÖ markdownlint installed successfully with npm"
          else
            echo "‚ö†Ô∏è  Failed to install with npm - trying with sudo..."
            echo "You may be prompted for your password:"
            if sudo npm install -g markdownlint-cli; then
              echo "‚úÖ markdownlint installed successfully with sudo"
            else
              echo "‚ùå Failed to install markdownlint with npm"
              echo ""
              echo "Alternative: Install to user directory:"
              echo "  npm install --prefix ~/.npm-global markdownlint-cli"
              echo "  export PATH=~/.npm-global/bin:\$PATH"
              exit 1
            fi
          fi
        # Try Homebrew as fallback
        elif command -v brew &> /dev/null; then
          echo "üì¶ Installing markdownlint with Homebrew..."
          brew install markdownlint-cli
        else
          echo "‚ùå Neither npm nor Homebrew found"
          echo ""
          echo "Please install Node.js or Homebrew first:"
          echo "  - Node.js: https://nodejs.org/"
          echo "  - Homebrew: https://brew.sh/"
          exit 1
        fi
        
        # Verify installation
        if command -v markdownlint &> /dev/null; then
          echo ""
          echo "‚úÖ markdownlint installed successfully!"
          echo "   Version: $(markdownlint --version)"
        else
          echo "‚ùå Installation failed"
          exit 1
        fi

  pr:fix:
    desc: Fix PR documentation formatting
    silent: true
    cmds:
      - |
        echo "üìù Fixing PR documentation..."
        pr_file=$(find . -name "pr.*.md" | head -1)
        if [ -n "$pr_file" ]; then
          echo "Found PR file: $pr_file"
          markdownlint "$pr_file" --fix
          echo "‚úÖ PR documentation fixed"
        else
          echo "No PR documentation found (pr.*.md)"
        fi